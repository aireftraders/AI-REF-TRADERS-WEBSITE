<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI REF-TRADERS - Games</title>
    <style>
        /* [All previous CSS styles remain exactly the same] */
    </style>
    <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
</head>
<body>
    <!-- [All previous HTML content remains exactly the same] -->

    <script>
        // Initialize Dexie database with same structure as ads.html
        const db = new Dexie("AI_REF_TRADERS_DB");
        db.version(1).stores({
            users: '++id, email, phone, balance, referrals, adsWatched, totalAdsWatched, verified, tradingActive, tradingCapital, dailyProfit, totalProfit, withdrawableProfit, bankDetails, paymentCircle, gameEarnings, lastAdWatchTime, streak, announcements, referrer',
            announcements: '++id, title, content, time, unread',
            supportTickets: '++id, userId, subject, message, status, createdAt',
            adminCredentials: '++id, username, password',
            transactions: '++id, userId, type, amount, status, timestamp'
        });

        // Game state management
        const gameState = {
            balance: 0,
            memory: { attempts: 10, wins: 0, earnings: 0 },
            dice: { attempts: 10, wins: 0, earnings: 0 },
            snake: { attempts: 10, score: 0, earnings: 0 },
            trivia: { attempts: 10, correct: 0, earnings: 0, usedQuestions: [] },
            wheel: { attempts: 10, wins: 0, earnings: 0 },
            ayo: { attempts: 10, wins: 0, earnings: 0 },
            nairaChase: { attempts: 10, score: 0, earnings: 0 },
            lastAccessTime: 0,
            adsWatched: 0,
            gameTimerStart: 0
        };

        // Load user data from IndexedDB
        async function loadUserData() {
            try {
                const userEmail = localStorage.getItem('userEmail');
                const userPhone = localStorage.getItem('userPhone');
                
                if (!userEmail && !userPhone) {
                    window.location.href = 'index.html';
                    return null;
                }
                
                let user = await db.users.where('email').equals(userEmail).or('phone').equals(userPhone).first();
                
                if (!user) {
                    user = {
                        email: userEmail,
                        phone: userPhone,
                        balance: 5000,
                        referrals: 0,
                        adsWatched: 0,
                        totalAdsWatched: 0,
                        tradingActive: false,
                        verified: false,
                        tradingCapital: 0,
                        dailyProfit: 0,
                        totalProfit: 0,
                        withdrawableProfit: 0,
                        bankDetails: null,
                        paymentCircle: { current: 0, total: 1000 },
                        gameEarnings: 0,
                        lastAdWatchTime: null,
                        streak: {
                            count: 0,
                            lastLogin: null,
                            bonus: 0
                        },
                        announcements: {
                            read: [2],
                            unread: [1]
                        },
                        referrer: null
                    };
                    await db.users.add(user);
                }
                
                return user;
            } catch (error) {
                console.error('Error loading user data:', error);
                return null;
            }
        }

        // Save user data to IndexedDB
        async function saveUserData(userData) {
            try {
                const userEmail = localStorage.getItem('userEmail');
                const userPhone = localStorage.getItem('userPhone');
                
                if (!userEmail && !userPhone) return;
                
                await db.users.where('email').equals(userEmail).or('phone').equals(userPhone).modify(userData);
            } catch (error) {
                console.error('Error saving user data:', error);
            }
        }

        // Initialize game state
        async function initializeGameState() {
            const urlParams = new URLSearchParams(window.location.search);
            const fromAds = urlParams.has('fromAds');
            
            try {
                const userData = await loadUserData();
                
                if (!userData) {
                    showAccessDenied("No user data found. Please watch ads first.");
                    return false;
                }
                
                // Check ads watched
                if (userData.adsWatched < 20) {
                    showAccessDenied(`You've only watched ${userData.adsWatched}/20 ads. Please complete watching ads.`);
                    return false;
                }
                
                // Check referrer
                if (!fromAds && !document.referrer.includes('ads.html')) {
                    showAccessDenied("Invalid access. Please use the game console button from ads page.");
                    return false;
                }
                
                // Initialize state
                gameState.balance = userData.balance || 0;
                gameState.adsWatched = userData.adsWatched || 0;
                gameState.gameEarnings = userData.gameEarnings || 0;
                
                const now = Date.now();
                const timeSinceLastAd = now - (userData.lastAdWatchTime || 0);
                
                if (fromAds || timeSinceLastAd >= 55 * 60 * 1000) {
                    // Reset game state for new session
                    gameState.memory.attempts = 10;
                    gameState.dice.attempts = 10;
                    gameState.snake.attempts = 10;
                    gameState.trivia.attempts = 10;
                    gameState.wheel.attempts = 10;
                    gameState.ayo.attempts = 10;
                    gameState.nairaChase.attempts = 10;
                    
                    gameState.memory.wins = 0;
                    gameState.memory.earnings = 0;
                    gameState.dice.wins = 0;
                    gameState.dice.earnings = 0;
                    gameState.snake.score = 0;
                    gameState.snake.earnings = 0;
                    gameState.trivia.correct = 0;
                    gameState.trivia.earnings = 0;
                    gameState.trivia.usedQuestions = [];
                    gameState.wheel.wins = 0;
                    gameState.wheel.earnings = 0;
                    gameState.ayo.wins = 0;
                    gameState.ayo.earnings = 0;
                    gameState.nairaChase.score = 0;
                    gameState.nairaChase.earnings = 0;
                    
                    gameState.gameTimerStart = now;
                    await saveUserData({
                        ...userData,
                        gameTimerStart: gameState.gameTimerStart
                    });
                    startGameTimer();
                } else {
                    // Load existing game state
                    if (userData.gameState) {
                        Object.assign(gameState, userData.gameState);
                    }
                    
                    if (userData.gameTimerStart) {
                        gameState.gameTimerStart = userData.gameTimerStart;
                        startGameTimer();
                    }
                }
                
                return true;
            } catch (error) {
                console.error('Error initializing game state:', error);
                showAccessDenied("Error loading game data. Please try again.");
                return false;
            }
        }

        function showAccessDenied(message) {
            document.getElementById('accessDeniedContainer').style.display = 'flex';
            document.getElementById('mainGameContainer').style.display = 'none';
            document.getElementById('timerDisplay').style.display = 'none';
            document.getElementById('accessDeniedMessage').textContent = message;
            
            document.getElementById('goToAdsBtn').addEventListener('click', () => {
                window.location.href = 'ads.html';
            });
        }

        function startGameTimer() {
            const timerDisplay = document.getElementById('timerDisplay');
            const timeRemaining = document.getElementById('timeRemaining');
            
            timerDisplay.style.display = 'block';
            
            const updateTimer = () => {
                const now = Date.now();
                const timeElapsed = now - gameState.gameTimerStart;
                const timeLeft = Math.max(0, 55 * 60 * 1000 - timeElapsed);
                
                const minutes = Math.floor(timeLeft / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                
                timeRemaining.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    showAccessDenied("Your game session has expired. Please watch ads again.");
                    setTimeout(() => {
                        window.location.href = 'ads.html';
                    }, 3000);
                }
            };
            
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
        }

        async function saveGameState() {
            try {
                const userEmail = localStorage.getItem('userEmail');
                const userPhone = localStorage.getItem('userPhone');
                
                if (!userEmail && !userPhone) return;
                
                let userData = await db.users.where('email').equals(userEmail).or('phone').equals(userPhone).first();
                
                if (!userData) return;
                
                userData = {
                    ...userData,
                    balance: gameState.balance,
                    gameEarnings: (userData.gameEarnings || 0) + 
                        (gameState.memory.earnings + 
                         gameState.dice.earnings + 
                         gameState.snake.earnings + 
                         gameState.trivia.earnings + 
                         gameState.wheel.earnings + 
                         gameState.ayo.earnings + 
                         gameState.nairaChase.earnings),
                    gameState: {
                        memory: gameState.memory,
                        dice: gameState.dice,
                        snake: gameState.snake,
                        trivia: gameState.trivia,
                        wheel: gameState.wheel,
                        ayo: gameState.ayo,
                        nairaChase: gameState.nairaChase
                    },
                    gameTimerStart: gameState.gameTimerStart
                };
                
                await saveUserData(userData);
                
                if (window.opener) {
                    window.opener.postMessage({
                        type: 'balanceUpdate',
                        balance: gameState.balance,
                        gameEarnings: userData.gameEarnings
                    }, '*');
                }
            } catch (error) {
                console.error('Error saving game state:', error);
            }
        }

        function updateBalance(amount) {
            gameState.balance += amount;
            document.getElementById('balanceDisplay').textContent = gameState.balance.toLocaleString();
            saveGameState();

            if (window.opener) {
                window.opener.postMessage({
                    type: 'balanceUpdate',
                    balance: gameState.balance
                }, '*');
            }
        }

        window.addEventListener('message', (event) => {
            if (event.data.type === 'balanceUpdate') {
                gameState.balance = event.data.balance;
                document.getElementById('balanceDisplay').textContent = gameState.balance.toLocaleString();
            }
        });

        function showNotification(message) {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function showGame(game) {
            document.querySelectorAll('.game-container').forEach(container => {
                container.classList.remove('active');
            });
            
            if (game) {
                const gameContainer = document.getElementById(`${game}Game`);
                if (gameContainer) {
                    gameContainer.classList.add('active');
                    gameContainer.scrollIntoView({ behavior: 'smooth' });
                }
            } else {
                document.querySelector('.container').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function updateGameUI() {
            // Memory game
            document.getElementById('memoryAttempts').textContent = gameState.memory.attempts;
            document.getElementById('memoryAttemptsDisplay').textContent = gameState.memory.attempts;
            document.getElementById('wins').textContent = gameState.memory.wins;
            document.getElementById('gameEarnings').textContent = gameState.memory.earnings;
            
            // Dice game
            document.getElementById('diceAttempts').textContent = gameState.dice.attempts;
            document.getElementById('diceAttemptsDisplay').textContent = gameState.dice.attempts;
            document.getElementById('diceWins').textContent = gameState.dice.wins;
            document.getElementById('diceEarnings').textContent = gameState.dice.earnings;
            
            // Snake game
            document.getElementById('snakeAttempts').textContent = gameState.snake.attempts;
            document.getElementById('snakeAttemptsDisplay').textContent = gameState.snake.attempts;
            document.getElementById('snakeScore').textContent = gameState.snake.score;
            document.getElementById('snakeEarnings').textContent = gameState.snake.earnings;
            
            // Trivia game
            document.getElementById('triviaAttempts').textContent = gameState.trivia.attempts;
            document.getElementById('triviaAttemptsDisplay').textContent = gameState.trivia.attempts;
            document.getElementById('triviaCorrect').textContent = gameState.trivia.correct;
            document.getElementById('triviaEarnings').textContent = gameState.trivia.earnings;
            
            // Wheel game
            document.getElementById('wheelAttempts').textContent = gameState.wheel.attempts;
            document.getElementById('wheelAttemptsDisplay').textContent = gameState.wheel.attempts;
            document.getElementById('wheelWins').textContent = gameState.wheel.wins;
            document.getElementById('wheelEarnings').textContent = gameState.wheel.earnings;
            
            // Ayo game
            document.getElementById('ayoAttempts').textContent = gameState.ayo.attempts;
            document.getElementById('ayoAttemptsDisplay').textContent = gameState.ayo.attempts;
            document.getElementById('ayoWins').textContent = gameState.ayo.wins;
            document.getElementById('ayoEarnings').textContent = gameState.ayo.earnings;
            
            // Naira Chase game
            document.getElementById('nairaChaseAttempts').textContent = gameState.nairaChase.attempts;
            document.getElementById('nairaChaseAttemptsDisplay').textContent = gameState.nairaChase.attempts;
            document.getElementById('nairaChaseGameScore').textContent = gameState.nairaChase.score;
            document.getElementById('nairaChaseGameEarnings').textContent = gameState.nairaChase.earnings;
        }

        // [All game implementations (memoryGame, diceGame, snakeGame, etc.) remain exactly the same]

        document.addEventListener('DOMContentLoaded', async () => {
            const accessGranted = await initializeGameState();
            
            if (!accessGranted) return;
            
            document.getElementById('mainGameContainer').style.display = 'block';
            
            // Initialize games
            memoryGame.init();
            diceGame.init();
            snakeGame.init();
            triviaGame.init();
            wheelGame.init();
            ayoGame.init();
            nairaChaseGame.init();
            
            updateGameUI();
            document.getElementById('balanceDisplay').textContent = gameState.balance.toLocaleString();
            
            window.addEventListener('online', updateSyncStatus);
            window.addEventListener('offline', updateSyncStatus);
            
            function updateSyncStatus() {
                const statusEl = document.getElementById('syncStatus');
                if (navigator.onLine) {
                    statusEl.textContent = 'Online';
                    statusEl.className = 'sync-status online';
                } else {
                    statusEl.textContent = 'Offline - Changes saved locally';
                    statusEl.className = 'sync-status offline';
                }
            }
            
            updateSyncStatus();
            
            document.querySelectorAll('.game-card').forEach(card => {
                card.addEventListener('click', () => {
                    showGame(card.dataset.game);
                });
            });
            
            document.getElementById('backToGames1').addEventListener('click', () => showGame(''));
            document.getElementById('backToGames2').addEventListener('click', () => showGame(''));
            document.getElementById('backToGames3').addEventListener('click', () => showGame(''));
            document.getElementById('backToGames4').addEventListener('click', () => showGame(''));
            document.getElementById('backToGames5').addEventListener('click', () => showGame(''));
            document.getElementById('backToGames6').addEventListener('click', () => showGame(''));
            document.getElementById('backToGames7').addEventListener('click', () => showGame(''));
            
            setInterval(() => {
                const now = new Date();
                const minutes = now.getMinutes();
                const seconds = now.getSeconds();
                
                if (minutes % 5 === 0 && seconds === 0) {
                    const messages = [
                        "üî• PLAY NOW! Big wins happening!",
                        "‚è≥ LIMITED TIME! Spin the wheel!",
                        "üí∞ HIGH PAYOUTS! Don't miss out!",
                        "üéÆ PLAYERS WINNING NOW! Join them!"
                    ];
                    const randomMsg = messages[Math.floor(Math.random() * messages.length)];
                    document.querySelector('.fomo-text').textContent = randomMsg;
                }
            }, 1000);
        });
    </script>
</body>
</html>
