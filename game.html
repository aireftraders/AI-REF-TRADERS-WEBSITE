<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI REF-TRADERS - Games</title>
    <!-- Include common CSS -->
    <link rel="stylesheet" href="common.css">
    <style>
        /* [Previous CSS styles remain exactly the same] */
    </style>
    <!-- Include Dexie.js for IndexedDB -->
    <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
</head>
<body>
    <!-- [All previous HTML content remains exactly the same until the scripts] -->

    <!-- Audio elements for game sounds -->
    <audio id="flipSound" src="https://assets.mixkit.co/sfx/preview/mixkit-game-click-1114.mp3" preload="auto"></audio>
    <audio id="winSound" src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3" preload="auto"></audio>
    <audio id="loseSound" src="https://assets.mixkit.co/sfx/preview/mixkit-retro-arcade-lose-2027.mp3" preload="auto"></audio>
    <audio id="clickSound" src="https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3" preload="auto"></audio>
    <audio id="coinFlipSound" src="https://assets.mixkit.co/sfx/preview/mixkit-coin-flip-1940.mp3" preload="auto"></audio>
    <audio id="coinLandSound" src="https://assets.mixkit.co/sfx/preview/mixkit-metal-hit-impact-2065.mp3" preload="auto"></audio>
    
    <script>
        // Initialize Dexie database with the same schema as ads.html and index.html
        const db = new Dexie("AI_REF_TRADERS_DB");
        
        // Define database schema (must match ads.html exactly)
        db.version(1).stores({
            users: '++id, email, phone, balance, referrals, adsWatched, totalAdsWatched, verified, tradingActive, tradingCapital, dailyProfit, totalProfit, withdrawableProfit, bankDetails, paymentCircle, gameEarnings, lastAdWatchTime, streak, announcements, referrer',
            announcements: '++id, title, content, time, unread',
            supportTickets: '++id, userId, subject, message, status, createdAt',
            adminCredentials: '++id, username, password',
            transactions: '++id, userId, type, amount, status, timestamp'
        });

        // ========================
        // GAME STATE MANAGEMENT
        // ========================
        
        const gameState = {
            balance: 0,
            memory: { attempts: 10, wins: 0, earnings: 0 },
            dice: { attempts: 10, wins: 0, earnings: 0 },
            snake: { attempts: 10, score: 0, earnings: 0 },
            trivia: { attempts: 10, correct: 0, earnings: 0, usedQuestions: [] },
            wheel: { attempts: 10, wins: 0, earnings: 0 },
            ayo: { attempts: 10, wins: 0, earnings: 0 },
            nairaChase: { attempts: 10, score: 0, earnings: 0 },
            lastAccessTime: 0,
            adsWatched: 0,
            gameTimerStart: 0
        };

        // Load user data from IndexedDB (same as ads.html)
        async function loadUserData() {
            try {
                const userEmail = localStorage.getItem('userEmail');
                const userPhone = localStorage.getItem('userPhone');
                
                if (!userEmail && !userPhone) {
                    // User not logged in, redirect to login
                    window.location.href = 'index.html';
                    return null;
                }
                
                // Check if user exists in database
                let user = await db.users.where('email').equals(userEmail).or('phone').equals(userPhone).first();
                
                if (!user) {
                    // Create new user with default values (matching ads.html schema)
                    user = {
                        email: userEmail,
                        phone: userPhone,
                        balance: 5000,
                        referrals: 0,
                        adsWatched: 0,
                        totalAdsWatched: 0,
                        tradingActive: false,
                        verified: false,
                        tradingCapital: 0,
                        dailyProfit: 0,
                        totalProfit: 0,
                        withdrawableProfit: 0,
                        bankDetails: null,
                        paymentCircle: { current: 0, total: 1000 },
                        gameEarnings: 0,
                        lastAdWatchTime: null,
                        streak: {
                            count: 0,
                            lastLogin: null,
                            bonus: 0
                        },
                        announcements: {
                            read: [2],
                            unread: [1]
                        },
                        referrer: null
                    };
                    
                    // Add new user to database
                    await db.users.add(user);
                }
                
                return user;
            } catch (error) {
                console.error('Error loading user data:', error);
                return null;
            }
        }

        // Save user data to IndexedDB (same as ads.html)
        async function saveUserData(userData) {
            try {
                const userEmail = localStorage.getItem('userEmail');
                const userPhone = localStorage.getItem('userPhone');
                
                if (!userEmail && !userPhone) {
                    console.error('No user email or phone found in localStorage');
                    return;
                }
                
                await db.users.where('email').equals(userEmail).or('phone').equals(userPhone).modify(userData);
            } catch (error) {
                console.error('Error saving user data:', error);
            }
        }

        // Initialize game state based on user data
        async function initializeGameState() {
            const urlParams = new URLSearchParams(window.location.search);
            const fromAds = urlParams.has('fromAds');
            
            try {
                const userData = await loadUserData();
                
                if (!userData) {
                    showAccessDenied("No user data found. Please watch ads first.");
                    return false;
                }
                
                // Check if user has watched 20 ads
                if (userData.adsWatched < 20) {
                    showAccessDenied(`You've only watched ${userData.adsWatched}/20 ads. Please complete watching ads.`);
                    return false;
                }
                
                // Check if coming from valid source
                if (!fromAds && !document.referrer.includes('ads.html')) {
                    showAccessDenied("Invalid access. Please use the game console button from ads page.");
                    return false;
                }
                
                // Initialize game state from user data
                gameState.balance = userData.balance || 0;
                gameState.adsWatched = userData.adsWatched || 0;
                gameState.gameEarnings = userData.gameEarnings || 0;
                
                // Check if we need to reset attempts (55 minutes since last ad watch)
                const now = Date.now();
                const timeSinceLastAd = now - (userData.lastAdWatchTime || 0);
                
                if (fromAds || timeSinceLastAd >= 55 * 60 * 1000) {
                    // Reset all attempts for fresh session
                    gameState.memory.attempts = 10;
                    gameState.dice.attempts = 10;
                    gameState.snake.attempts = 10;
                    gameState.trivia.attempts = 10;
                    gameState.wheel.attempts = 10;
                    gameState.ayo.attempts = 10;
                    gameState.nairaChase.attempts = 10;
                    
                    // Reset game stats
                    gameState.memory.wins = 0;
                    gameState.memory.earnings = 0;
                    gameState.dice.wins = 0;
                    gameState.dice.earnings = 0;
                    gameState.snake.score = 0;
                    gameState.snake.earnings = 0;
                    gameState.trivia.correct = 0;
                    gameState.trivia.earnings = 0;
                    gameState.trivia.usedQuestions = [];
                    gameState.wheel.wins = 0;
                    gameState.wheel.earnings = 0;
                    gameState.ayo.wins = 0;
                    gameState.ayo.earnings = 0;
                    gameState.nairaChase.score = 0;
                    gameState.nairaChase.earnings = 0;
                    
                    // Start game timer
                    gameState.gameTimerStart = now;
                    await saveUserData({
                        ...userData,
                        gameTimerStart: gameState.gameTimerStart
                    });
                    startGameTimer();
                } else {
                    // Load existing game state if available
                    if (userData.gameState) {
                        Object.assign(gameState, userData.gameState);
                    }
                    
                    // Continue existing timer
                    if (userData.gameTimerStart) {
                        gameState.gameTimerStart = userData.gameTimerStart;
                        startGameTimer();
                    }
                }
                
                return true;
            } catch (error) {
                console.error('Error initializing game state:', error);
                showAccessDenied("Error loading game data. Please try again.");
                return false;
            }
        }

        // Show access denied message
        function showAccessDenied(message) {
            document.getElementById('accessDeniedContainer').style.display = 'flex';
            document.getElementById('mainGameContainer').style.display = 'none';
            document.getElementById('timerDisplay').style.display = 'none';
            document.getElementById('accessDeniedMessage').textContent = message;
            
            document.getElementById('goToAdsBtn').addEventListener('click', () => {
                window.location.href = 'ads.html';
            });
        }

        // Start game timer (55 minutes)
        function startGameTimer() {
            const timerDisplay = document.getElementById('timerDisplay');
            const timeRemaining = document.getElementById('timeRemaining');
            
            timerDisplay.style.display = 'block';
            
            const updateTimer = () => {
                const now = Date.now();
                const timeElapsed = now - gameState.gameTimerStart;
                const timeLeft = Math.max(0, 55 * 60 * 1000 - timeElapsed);
                
                const minutes = Math.floor(timeLeft / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                
                timeRemaining.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    showAccessDenied("Your game session has expired. Please watch ads again.");
                    setTimeout(() => {
                        window.location.href = 'ads.html';
                    }, 3000);
                }
            };
            
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
        }

        // Save game state to IndexedDB
        async function saveGameState() {
            try {
                const userEmail = localStorage.getItem('userEmail');
                const userPhone = localStorage.getItem('userPhone');
                
                if (!userEmail && !userPhone) {
                    console.error('No user email or phone found in localStorage');
                    return;
                }
                
                // Get current user data
                let userData = await db.users.where('email').equals(userEmail).or('phone').equals(userPhone).first();
                
                if (!userData) return;
                
                // Update user data with game state
                userData = {
                    ...userData,
                    balance: gameState.balance,
                    gameEarnings: (userData.gameEarnings || 0) + 
                        (gameState.memory.earnings + 
                         gameState.dice.earnings + 
                         gameState.snake.earnings + 
                         gameState.trivia.earnings + 
                         gameState.wheel.earnings + 
                         gameState.ayo.earnings + 
                         gameState.nairaChase.earnings),
                    gameState: {
                        memory: { 
                            attempts: gameState.memory.attempts, 
                            wins: gameState.memory.wins, 
                            earnings: gameState.memory.earnings 
                        },
                        dice: { 
                            attempts: gameState.dice.attempts, 
                            wins: gameState.dice.wins, 
                            earnings: gameState.dice.earnings 
                        },
                        snake: { 
                            attempts: gameState.snake.attempts, 
                            score: gameState.snake.score, 
                            earnings: gameState.snake.earnings 
                        },
                        trivia: { 
                            attempts: gameState.trivia.attempts, 
                            correct: gameState.trivia.correct, 
                            earnings: gameState.trivia.earnings,
                            usedQuestions: gameState.trivia.usedQuestions
                        },
                        wheel: { 
                            attempts: gameState.wheel.attempts, 
                            wins: gameState.wheel.wins, 
                            earnings: gameState.wheel.earnings 
                        },
                        ayo: { 
                            attempts: gameState.ayo.attempts, 
                            wins: gameState.ayo.wins, 
                            earnings: gameState.ayo.earnings 
                        },
                        nairaChase: {
                            attempts: gameState.nairaChase.attempts,
                            score: gameState.nairaChase.score,
                            earnings: gameState.nairaChase.earnings
                        }
                    },
                    gameTimerStart: gameState.gameTimerStart
                };
                
                await saveUserData(userData);
                
                // Notify parent window (index.html) of balance update
                if (window.opener) {
                    window.opener.postMessage({
                        type: 'balanceUpdate',
                        balance: gameState.balance,
                        gameEarnings: userData.gameEarnings
                    }, '*');
                }
            } catch (error) {
                console.error('Error saving game state:', error);
            }
        }

        // Update balance and notify parent window
        function updateBalance(amount) {
            gameState.balance += amount;
            document.getElementById('balanceDisplay').textContent = gameState.balance.toLocaleString();
            saveGameState();

            // Notify parent window (index.html) of the balance update
            if (window.opener) {
                window.opener.postMessage({
                    type: 'balanceUpdate',
                    balance: gameState.balance
                }, '*');
            }
        }

        // Listen for balance updates from parent window
        window.addEventListener('message', (event) => {
            if (event.data.type === 'balanceUpdate') {
                gameState.balance = event.data.balance;
                document.getElementById('balanceDisplay').textContent = gameState.balance.toLocaleString();
            }
        });

        // [Rest of the game implementations (memoryGame, diceGame, snakeGame, etc.) remain exactly the same]
        
        // ========================
        // INITIALIZATION
        // ========================
        
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize game state
            const accessGranted = await initializeGameState();
            
            if (!accessGranted) return;
            
            // Show main game container
            document.getElementById('mainGameContainer').style.display = 'block';
            
            // Initialize games
            memoryGame.init();
            diceGame.init();
            snakeGame.init();
            triviaGame.init();
            wheelGame.init();
            ayoGame.init();
            nairaChaseGame.init();
            
            // Update UI with current state
            updateGameUI();
            document.getElementById('balanceDisplay').textContent = gameState.balance.toLocaleString();
            
            // Set up online/offline detection
            window.addEventListener('online', updateSyncStatus);
            window.addEventListener('offline', updateSyncStatus);
            
            function updateSyncStatus() {
                const statusEl = document.getElementById('syncStatus');
                if (navigator.onLine) {
                    statusEl.textContent = 'Online';
                    statusEl.className = 'sync-status online';
                } else {
                    statusEl.textContent = 'Offline - Changes saved locally';
                    statusEl.className = 'sync-status offline';
                }
            }
            
            // Initial sync check
            updateSyncStatus();
            
            // Game card click handlers
            document.querySelectorAll('.game-card').forEach(card => {
                card.addEventListener('click', () => {
                    showGame(card.dataset.game);
                });
            });
            
            // Back to games buttons
            document.getElementById('backToGames1').addEventListener('click', () => showGame(''));
            document.getElementById('backToGames2').addEventListener('click', () => showGame(''));
            document.getElementById('backToGames3').addEventListener('click', () => showGame(''));
            document.getElementById('backToGames4').addEventListener('click', () => showGame(''));
            document.getElementById('backToGames5').addEventListener('click', () => showGame(''));
            document.getElementById('backToGames6').addEventListener('click', () => showGame(''));
            document.getElementById('backToGames7').addEventListener('click', () => showGame(''));
            
            // Update FOMO timer
            setInterval(() => {
                const now = new Date();
                const minutes = now.getMinutes();
                const seconds = now.getSeconds();
                
                // Show different messages based on time
                if (minutes % 5 === 0 && seconds === 0) {
                    const messages = [
                        "üî• PLAY NOW! Big wins happening!",
                        "‚è≥ LIMITED TIME! Spin the wheel!",
                        "üí∞ HIGH PAYOUTS! Don't miss out!",
                        "üéÆ PLAYERS WINNING NOW! Join them!"
                    ];
                    const randomMsg = messages[Math.floor(Math.random() * messages.length)];
                    document.querySelector('.fomo-text').textContent = randomMsg;
                }
            }, 1000);
        });
    </script>
</body>
</html>
