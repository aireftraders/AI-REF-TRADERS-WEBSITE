<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI REF-TRADERS - Games</title>
    <style>
        /* Common styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: #2c3e50;
            color: white;
            padding: 15px 0;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .balance-container {
            background-color: #3498db;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .game-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .game-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .game-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .game-card img {
            width: 100px;
            height: 100px;
            object-fit: contain;
            margin-bottom: 15px;
        }
        
        .game-card h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .game-card p {
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .attempts-info {
            font-size: 12px;
            color: #e74c3c;
            margin-top: 5px;
        }
        
        /* Game specific containers */
        .game-container {
            display: none;
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        /* Timer display */
        #timerDisplay {
            background-color: #2c3e50;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        
        /* Access denied container */
        #accessDeniedContainer {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 80vh;
            text-align: center;
        }
        
        #accessDeniedContainer h2 {
            color: #e74c3c;
            margin-bottom: 20px;
        }
        
        #accessDeniedContainer p {
            margin-bottom: 30px;
            font-size: 18px;
        }
        
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        /* FOMO banner */
        .fomo-banner {
            background-color: #e74c3c;
            color: white;
            padding: 10px;
            text-align: center;
            border-radius: 5px;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.8; }
            50% { opacity: 1; }
            100% { opacity: 0.8; }
        }
        
        /* Sync status */
        .sync-status {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .sync-status.online {
            background-color: #2ecc71;
            color: white;
        }
        
        .sync-status.offline {
            background-color: #e74c3c;
            color: white;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .game-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
        }
        
        @media (max-width: 480px) {
            .game-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <!-- Include Dexie.js for IndexedDB -->
    <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
</head>
<body>
    <div class="container">
        <!-- Access Denied Container (shown when access is denied) -->
        <div id="accessDeniedContainer">
            <h2>Access Denied</h2>
            <p id="accessDeniedMessage"></p>
            <button id="goToAdsBtn" class="btn">Go to Ads Page</button>
        </div>
        
        <!-- Timer Display -->
        <div id="timerDisplay">
            Game session time remaining: <span id="timeRemaining">60:00</span>
        </div>
        
        <!-- FOMO Banner -->
        <div class="fomo-banner">
            <span class="fomo-text">🔥 PLAY NOW! Big wins happening!</span>
        </div>
        
        <!-- Main Game Container (shown when access is granted) -->
        <div id="mainGameContainer">
            <header>
                <h1>AI REF-TRADERS GAME CONSOLE</h1>
                <p>Earn money by playing these games</p>
            </header>
            
            <div class="balance-container">
                <div>
                    <h3>Your Balance</h3>
                    <p>₦<span id="balanceDisplay">0</span></p>
                </div>
                <div>
                    <span id="syncStatus" class="sync-status online">Online</span>
                </div>
            </div>
            
            <!-- Game Grid -->
            <div class="game-grid">
                <!-- Memory Game Card -->
                <div class="game-card" data-game="memory">
                    <img src="https://cdn-icons-png.flaticon.com/512/3522/3522697.png" alt="Memory Game">
                    <h3>Memory Match</h3>
                    <p>Match pairs of cards to win money</p>
                    <p class="attempts-info">Attempts left: <span id="memoryAttempts">10</span></p>
                </div>
                
                <!-- Dice Game Card -->
                <div class="game-card" data-game="dice">
                    <img src="https://cdn-icons-png.flaticon.com/512/2693/2693739.png" alt="Dice Game">
                    <h3>Lucky Dice</h3>
                    <p>Roll dice and guess the outcome</p>
                    <p class="attempts-info">Attempts left: <span id="diceAttempts">10</span></p>
                </div>
                
                <!-- Snake Game Card -->
                <div class="game-card" data-game="snake">
                    <img src="https://cdn-icons-png.flaticon.com/512/2965/2965879.png" alt="Snake Game">
                    <h3>Snake</h3>
                    <p>Classic snake game with rewards</p>
                    <p class="attempts-info">Attempts left: <span id="snakeAttempts">10</span></p>
                </div>
                
                <!-- Trivia Game Card -->
                <div class="game-card" data-game="trivia">
                    <img src="https://cdn-icons-png.flaticon.com/512/3132/3132693.png" alt="Trivia Game">
                    <h3>Trivia Challenge</h3>
                    <p>Answer questions to win money</p>
                    <p class="attempts-info">Attempts left: <span id="triviaAttempts">10</span></p>
                </div>
                
                <!-- Wheel Game Card -->
                <div class="game-card" data-game="wheel">
                    <img src="https://cdn-icons-png.flaticon.com/512/3209/3209260.png" alt="Wheel Game">
                    <h3>Spin the Wheel</h3>
                    <p>Spin for instant prizes</p>
                    <p class="attempts-info">Attempts left: <span id="wheelAttempts">10</span></p>
                </div>
                
                <!-- Ayo Game Card -->
                <div class="game-card" data-game="ayo">
                    <img src="https://cdn-icons-png.flaticon.com/512/3199/3199937.png" alt="Ayo Game">
                    <h3>Ayo Olopon</h3>
                    <p>Traditional Nigerian game</p>
                    <p class="attempts-info">Attempts left: <span id="ayoAttempts">10</span></p>
                </div>
                
                <!-- Naira Chase Game Card -->
                <div class="game-card" data-game="nairaChase">
                    <img src="https://cdn-icons-png.flaticon.com/512/2936/2936886.png" alt="Naira Chase">
                    <h3>Naira Chase</h3>
                    <p>Catch falling money</p>
                    <p class="attempts-info">Attempts left: <span id="nairaChaseAttempts">10</span></p>
                </div>
            </div>
            
            <!-- Game Containers (hidden by default) -->
            <!-- Memory Game Container -->
            <div id="memoryGameContainer" class="game-container">
                <h2>Memory Match Game</h2>
                <p>Match pairs of cards to win ₦100 per match. Complete all pairs to win ₦500 bonus!</p>
                <div id="memoryGameBoard" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 20px 0;"></div>
                <button id="startMemoryGame" class="btn">Start Game</button>
                <button id="backToGames1" class="btn" style="background-color: #7f8c8d; margin-left: 10px;">Back to Games</button>
                <div id="memoryGameStats" style="margin-top: 20px;">
                    <p>Matches found: <span id="memoryMatches">0</span>/8</p>
                    <p>Current win: ₦<span id="memoryCurrentWin">0</span></p>
                </div>
            </div>
            
            <!-- Dice Game Container -->
            <div id="diceGameContainer" class="game-container">
                <h2>Lucky Dice Game</h2>
                <p>Guess if the sum of two dice will be higher or lower than 7. Win ₦200 per correct guess!</p>
                <div style="display: flex; justify-content: center; gap: 30px; margin: 20px 0;">
                    <div id="dice1" style="font-size: 50px;">🎲</div>
                    <div id="dice2" style="font-size: 50px;">🎲</div>
                </div>
                <div style="margin: 20px 0;">
                    <button id="guessHigher" class="btn">Higher than 7</button>
                    <button id="guessLower" class="btn">Lower than 7</button>
                    <button id="guessSeven" class="btn" style="background-color: #f39c12;">Exactly 7 (3x payout)</button>
                </div>
                <button id="rollDice" class="btn">Roll Dice</button>
                <button id="backToGames2" class="btn" style="background-color: #7f8c8d; margin-left: 10px;">Back to Games</button>
                <div id="diceGameStats" style="margin-top: 20px;">
                    <p>Last result: <span id="diceLastResult">-</span></p>
                    <p>Wins: <span id="diceWins">0</span>/<span id="diceTotalAttempts">10</span></p>
                    <p>Total winnings: ₦<span id="diceTotalWinnings">0</span></p>
                </div>
            </div>
            
            <!-- Snake Game Container -->
            <div id="snakeGameContainer" class="game-container">
                <h2>Snake Game</h2>
                <p>Eat the food to grow your snake. Earn ₦10 per food and ₦100 bonus for every 10 foods!</p>
                <canvas id="snakeCanvas" width="400" height="400" style="border: 1px solid #ddd; display: block; margin: 20px auto;"></canvas>
                <div style="text-align: center;">
                    <button id="startSnakeGame" class="btn">Start Game</button>
                    <button id="backToGames3" class="btn" style="background-color: #7f8c8d; margin-left: 10px;">Back to Games</button>
                </div>
                <div id="snakeGameStats" style="margin-top: 20px; text-align: center;">
                    <p>Score: <span id="snakeScore">0</span></p>
                    <p>Current earnings: ₦<span id="snakeEarnings">0</span></p>
                    <p>High score: <span id="snakeHighScore">0</span></p>
                </div>
            </div>
            
            <!-- Trivia Game Container -->
            <div id="triviaGameContainer" class="game-container">
                <h2>Trivia Challenge</h2>
                <p>Answer trivia questions correctly to earn ₦150 per question!</p>
                <div id="triviaQuestionContainer" style="margin: 20px 0; padding: 15px; background-color: #f8f9fa; border-radius: 5px;">
                    <p id="triviaQuestion">Press "Start Game" to begin</p>
                    <div id="triviaOptions" style="margin-top: 15px;"></div>
                </div>
                <button id="startTriviaGame" class="btn">Start Game</button>
                <button id="backToGames4" class="btn" style="background-color: #7f8c8d; margin-left: 10px;">Back to Games</button>
                <div id="triviaGameStats" style="margin-top: 20px;">
                    <p>Correct answers: <span id="triviaCorrect">0</span>/<span id="triviaTotalAttempts">10</span></p>
                    <p>Total winnings: ₦<span id="triviaTotalWinnings">0</span></p>
                </div>
            </div>
            
            <!-- Wheel Game Container -->
            <div id="wheelGameContainer" class="game-container">
                <h2>Spin the Wheel</h2>
                <p>Spin the wheel for a chance to win between ₦50 and ₦1000!</p>
                <div style="text-align: center; margin: 20px 0;">
                    <canvas id="wheelCanvas" width="300" height="300"></canvas>
                </div>
                <div style="text-align: center;">
                    <button id="spinWheel" class="btn">Spin Wheel (Cost: 1 attempt)</button>
                    <button id="backToGames5" class="btn" style="background-color: #7f8c8d; margin-left: 10px;">Back to Games</button>
                </div>
                <div id="wheelGameStats" style="margin-top: 20px; text-align: center;">
                    <p>Last win: ₦<span id="wheelLastWin">0</span></p>
                    <p>Total winnings: ₦<span id="wheelTotalWinnings">0</span></p>
                </div>
            </div>
            
            <!-- Ayo Game Container -->
            <div id="ayoGameContainer" class="game-container">
                <h2>Ayo Olopon</h2>
                <p>Play the traditional Nigerian game against the computer. Win ₦300 per game!</p>
                <div id="ayoBoard" style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; margin: 20px 0;"></div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                    <div>
                        <p>Player 1 (You)</p>
                        <p>Score: <span id="ayoPlayerScore">0</span></p>
                    </div>
                    <div>
                        <p>Player 2 (Computer)</p>
                        <p>Score: <span id="ayoComputerScore">0</span></p>
                    </div>
                </div>
                <button id="startAyoGame" class="btn">Start Game</button>
                <button id="backToGames6" class="btn" style="background-color: #7f8c8d; margin-left: 10px;">Back to Games</button>
                <div id="ayoGameStats" style="margin-top: 20px;">
                    <p>Wins: <span id="ayoWins">0</span>/<span id="ayoTotalAttempts">10</span></p>
                    <p>Total winnings: ₦<span id="ayoTotalWinnings">0</span></p>
                </div>
            </div>
            
            <!-- Naira Chase Game Container -->
            <div id="nairaChaseGameContainer" class="game-container">
                <h2>Naira Chase</h2>
                <p>Catch falling Naira notes to earn money. Each note is worth ₦10-₦100!</p>
                <canvas id="nairaChaseCanvas" width="400" height="500" style="border: 1px solid #ddd; display: block; margin: 20px auto;"></canvas>
                <div style="text-align: center;">
                    <button id="startNairaChase" class="btn">Start Game</button>
                    <button id="backToGames7" class="btn" style="background-color: #7f8c8d; margin-left: 10px;">Back to Games</button>
                </div>
                <div id="nairaChaseStats" style="margin-top: 20px; text-align: center;">
                    <p>Score: <span id="nairaChaseScore">0</span></p>
                    <p>Current earnings: ₦<span id="nairaChaseEarnings">0</span></p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Audio elements for game sounds -->
    <audio id="flipSound" src="https://assets.mixkit.co/sfx/preview/mixkit-game-click-1114.mp3" preload="auto"></audio>
    <audio id="winSound" src="https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3" preload="auto"></audio>
    <audio id="loseSound" src="https://assets.mixkit.co/sfx/preview/mixkit-retro-arcade-lose-2027.mp3" preload="auto"></audio>
    <audio id="clickSound" src="https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3" preload="auto"></audio>
    <audio id="coinFlipSound" src="https://assets.mixkit.co/sfx/preview/mixkit-coin-flip-1940.mp3" preload="auto"></audio>
    <audio id="coinLandSound" src="https://assets.mixkit.co/sfx/preview/mixkit-metal-hit-impact-2065.mp3" preload="auto"></audio>
    
    <script>
        // Initialize Dexie database with the same schema as ads.html and index.html
        const db = new Dexie("AI_REF_TRADERS_DB");
        
        // Define database schema (must match ads.html exactly)
        db.version(1).stores({
            users: '++id, email, phone, balance, referrals, adsWatched, totalAdsWatched, verified, tradingActive, tradingCapital, dailyProfit, totalProfit, withdrawableProfit, bankDetails, paymentCircle, gameEarnings, lastAdWatchTime, streak, announcements, referrer',
            announcements: '++id, title, content, time, unread',
            supportTickets: '++id, userId, subject, message, status, createdAt',
            adminCredentials: '++id, username, password',
            transactions: '++id, userId, type, amount, status, timestamp',
            gameSessions: '++id, userId, startTime, endTime, attemptsUsed, gamesPlayed'
        });

        // ========================
        // GAME STATE MANAGEMENT
        // ========================
        
        const gameState = {
            balance: 0,
            memory: { attempts: 10, wins: 0, earnings: 0 },
            dice: { attempts: 10, wins: 0, earnings: 0 },
            snake: { attempts: 10, score: 0, earnings: 0 },
            trivia: { attempts: 10, correct: 0, earnings: 0, usedQuestions: [] },
            wheel: { attempts: 10, wins: 0, earnings: 0 },
            ayo: { attempts: 10, wins: 0, earnings: 0 },
            nairaChase: { attempts: 10, score: 0, earnings: 0 },
            lastAccessTime: 0,
            adsWatched: 0,
            gameTimerStart: 0,
            dailySessions: 0,
            lastSessionReset: 0
        };

        // Load user data from IndexedDB (same as ads.html)
        async function loadUserData() {
            try {
                const userEmail = localStorage.getItem('userEmail');
                const userPhone = localStorage.getItem('userPhone');
                
                if (!userEmail && !userPhone) {
                    // User not logged in, redirect to login
                    window.location.href = 'index.html';
                    return null;
                }
                
                // Check if user exists in database
                let user = await db.users.where('email').equals(userEmail).or('phone').equals(userPhone).first();
                
                if (!user) {
                    // Create new user with default values (matching ads.html schema)
                    user = {
                        email: userEmail,
                        phone: userPhone,
                        balance: 5000,
                        referrals: 0,
                        adsWatched: 0,
                        totalAdsWatched: 0,
                        tradingActive: false,
                        verified: false,
                        tradingCapital: 0,
                        dailyProfit: 0,
                        totalProfit: 0,
                        withdrawableProfit: 0,
                        bankDetails: null,
                        paymentCircle: { current: 0, total: 1000 },
                        gameEarnings: 0,
                        lastAdWatchTime: null,
                        streak: {
                            count: 0,
                            lastLogin: null,
                            bonus: 0
                        },
                        announcements: {
                            read: [2],
                            unread: [1]
                        },
                        referrer: null
                    };
                    
                    // Add new user to database
                    await db.users.add(user);
                }
                
                return user;
            } catch (error) {
                console.error('Error loading user data:', error);
                return null;
            }
        }

        // Save user data to IndexedDB (same as ads.html)
        async function saveUserData(userData) {
            try {
                const userEmail = localStorage.getItem('userEmail');
                const userPhone = localStorage.getItem('userPhone');
                
                if (!userEmail && !userPhone) {
                    console.error('No user email or phone found in localStorage');
                    return;
                }
                
                await db.users.where('email').equals(userEmail).or('phone').equals(userPhone).modify(userData);
            } catch (error) {
                console.error('Error saving user data:', error);
            }
        }

        // Check daily session limit (10 per 24 hours)
        async function checkDailySessions() {
            try {
                const userEmail = localStorage.getItem('userEmail');
                const userPhone = localStorage.getItem('userPhone');
                
                // Get today's game sessions
                const now = Date.now();
                const twentyFourHoursAgo = now - (24 * 60 * 60 * 1000);
                
                const sessions = await db.gameSessions
                    .where('userId').equals(userEmail || userPhone)
                    .and(session => session.startTime >= twentyFourHoursAgo)
                    .toArray();
                
                return sessions.length;
            } catch (error) {
                console.error('Error checking daily sessions:', error);
                return 0;
            }
        }

        // Record a new game session
        async function recordGameSession() {
            try {
                const userEmail = localStorage.getItem('userEmail');
                const userPhone = localStorage.getItem('userPhone');
                const now = Date.now();
                
                await db.gameSessions.add({
                    userId: userEmail || userPhone,
                    startTime: now,
                    endTime: now + (60 * 60 * 1000), // 60 minutes from now
                    attemptsUsed: 0,
                    gamesPlayed: 0
                });
            } catch (error) {
                console.error('Error recording game session:', error);
            }
        }

        // Initialize game state based on user data
        async function initializeGameState() {
            const urlParams = new URLSearchParams(window.location.search);
            const fromAds = urlParams.has('fromAds');
            
            try {
                const userData = await loadUserData();
                
                if (!userData) {
                    showAccessDenied("No user data found. Please watch ads first.");
                    return false;
                }
                
                // Check daily session limit (10 per 24 hours)
                const sessionsToday = await checkDailySessions();
                if (sessionsToday >= 10) {
                    showAccessDenied("You've reached your daily limit of 10 game sessions. Please try again tomorrow.");
                    return false;
                }
                
                // Check if user has watched 20 ads
                if (userData.adsWatched < 20) {
                    showAccessDenied(`You've only watched ${userData.adsWatched}/20 ads. Please complete watching ads.`);
                    return false;
                }
                
                // Check if coming from valid source
                if (!fromAds && !document.referrer.includes('ads.html')) {
                    showAccessDenied("Invalid access. Please use the game console button from ads page.");
                    return false;
                }
                
                // Initialize game state from user data
                gameState.balance = userData.balance || 0;
                gameState.adsWatched = userData.adsWatched || 0;
                gameState.gameEarnings = userData.gameEarnings || 0;
                
                // Check if we need to reset attempts (60 minutes since last ad watch)
                const now = Date.now();
                const timeSinceLastAd = now - (userData.lastAdWatchTime || 0);
                
                if (fromAds || timeSinceLastAd >= 60 * 60 * 1000) {
                    // Reset all attempts for fresh session
                    gameState.memory.attempts = 10;
                    gameState.dice.attempts = 10;
                    gameState.snake.attempts = 10;
                    gameState.trivia.attempts = 10;
                    gameState.wheel.attempts = 10;
                    gameState.ayo.attempts = 10;
                    gameState.nairaChase.attempts = 10;
                    
                    // Reset game stats
                    gameState.memory.wins = 0;
                    gameState.memory.earnings = 0;
                    gameState.dice.wins = 0;
                    gameState.dice.earnings = 0;
                    gameState.snake.score = 0;
                    gameState.snake.earnings = 0;
                    gameState.trivia.correct = 0;
                    gameState.trivia.earnings = 0;
                    gameState.trivia.usedQuestions = [];
                    gameState.wheel.wins = 0;
                    gameState.wheel.earnings = 0;
                    gameState.ayo.wins = 0;
                    gameState.ayo.earnings = 0;
                    gameState.nairaChase.score = 0;
                    gameState.nairaChase.earnings = 0;
                    
                    // Start game timer
                    gameState.gameTimerStart = now;
                    await saveUserData({
                        ...userData,
                        gameTimerStart: gameState.gameTimerStart
                    });
                    
                    // Record new game session
                    await recordGameSession();
                    
                    startGameTimer();
                } else {
                    // Load existing game state if available
                    if (userData.gameState) {
                        Object.assign(gameState, userData.gameState);
                    }
                    
                    // Continue existing timer
                    if (userData.gameTimerStart) {
                        gameState.gameTimerStart = userData.gameTimerStart;
                        startGameTimer();
                    }
                }
                
                return true;
            } catch (error) {
                console.error('Error initializing game state:', error);
                showAccessDenied("Error loading game data. Please try again.");
                return false;
            }
        }

        // Show access denied message
        function showAccessDenied(message) {
            document.getElementById('accessDeniedContainer').style.display = 'flex';
            document.getElementById('mainGameContainer').style.display = 'none';
            document.getElementById('timerDisplay').style.display = 'none';
            document.getElementById('accessDeniedMessage').textContent = message;
            
            document.getElementById('goToAdsBtn').addEventListener('click', () => {
                window.location.href = 'ads.html';
            });
        }

        // Start game timer (60 minutes)
        function startGameTimer() {
            const timerDisplay = document.getElementById('timerDisplay');
            const timeRemaining = document.getElementById('timeRemaining');
            
            timerDisplay.style.display = 'block';
            
            const updateTimer = () => {
                const now = Date.now();
                const timeElapsed = now - gameState.gameTimerStart;
                const timeLeft = Math.max(0, 60 * 60 * 1000 - timeElapsed);
                
                const minutes = Math.floor(timeLeft / (1000 * 60));
                const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
                
                timeRemaining.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    showAccessDenied("Your game session has expired. Please watch ads again.");
                    setTimeout(() => {
                        window.location.href = 'ads.html';
                    }, 3000);
                }
            };
            
            updateTimer();
            const timerInterval = setInterval(updateTimer, 1000);
        }

        // Save game state to IndexedDB
        async function saveGameState() {
            try {
                const userEmail = localStorage.getItem('userEmail');
                const userPhone = localStorage.getItem('userPhone');
                
                if (!userEmail && !userPhone) {
                    console.error('No user email or phone found in localStorage');
                    return;
                }
                
                // Get current user data
                let userData = await db.users.where('email').equals(userEmail).or('phone').equals(userPhone).first();
                
                if (!userData) return;
                
                // Update user data with game state
                userData = {
                    ...userData,
                    balance: gameState.balance,
                    gameEarnings: (userData.gameEarnings || 0) + 
                        (gameState.memory.earnings + 
                         gameState.dice.earnings + 
                         gameState.snake.earnings + 
                         gameState.trivia.earnings + 
                         gameState.wheel.earnings + 
                         gameState.ayo.earnings + 
                         gameState.nairaChase.earnings),
                    gameState: {
                        memory: { 
                            attempts: gameState.memory.attempts, 
                            wins: gameState.memory.wins, 
                            earnings: gameState.memory.earnings 
                        },
                        dice: { 
                            attempts: gameState.dice.attempts, 
                            wins: gameState.dice.wins, 
                            earnings: gameState.dice.earnings 
                        },
                        snake: { 
                            attempts: gameState.snake.attempts, 
                            score: gameState.snake.score, 
                            earnings: gameState.snake.earnings 
                        },
                        trivia: { 
                            attempts: gameState.trivia.attempts, 
                            correct: gameState.trivia.correct, 
                            earnings: gameState.trivia.earnings,
                            usedQuestions: gameState.trivia.usedQuestions
                        },
                        wheel: { 
                            attempts: gameState.wheel.attempts, 
                            wins: gameState.wheel.wins, 
                            earnings: gameState.wheel.earnings 
                        },
                        ayo: { 
                            attempts: gameState.ayo.attempts, 
                            wins: gameState.ayo.wins, 
                            earnings: gameState.ayo.earnings 
                        },
                        nairaChase: {
                            attempts: gameState.nairaChase.attempts,
                            score: gameState.nairaChase.score,
                            earnings: gameState.nairaChase.earnings
                        }
                    },
                    gameTimerStart: gameState.gameTimerStart
                };
                
                await saveUserData(userData);
                
                // Notify parent window (index.html) of balance update
                if (window.opener) {
                    window.opener.postMessage({
                        type: 'balanceUpdate',
                        balance: gameState.balance,
                        gameEarnings: userData.gameEarnings
                    }, '*');
                }
            } catch (error) {
                console.error('Error saving game state:', error);
            }
        }

        // Update balance and notify parent window
        function updateBalance(amount) {
            gameState.balance += amount;
            document.getElementById('balanceDisplay').textContent = gameState.balance.toLocaleString();
            saveGameState();

            // Notify parent window (index.html) of the balance update
            if (window.opener) {
                window.opener.postMessage({
                    type: 'balanceUpdate',
                    balance: gameState.balance
                }, '*');
            }
        }

        // Listen for balance updates from parent window
        window.addEventListener('message', (event) => {
            if (event.data.type === 'balanceUpdate') {
                gameState.balance = event.data.balance;
                document.getElementById('balanceDisplay').textContent = gameState.balance.toLocaleString();
            }
        });

        // Update game UI with current attempts
        function updateGameUI() {
            document.getElementById('memoryAttempts').textContent = gameState.memory.attempts;
            document.getElementById('diceAttempts').textContent = gameState.dice.attempts;
            document.getElementById('snakeAttempts').textContent = gameState.snake.attempts;
            document.getElementById('triviaAttempts').textContent = gameState.trivia.attempts;
            document.getElementById('wheelAttempts').textContent = gameState.wheel.attempts;
            document.getElementById('ayoAttempts').textContent = gameState.ayo.attempts;
            document.getElementById('nairaChaseAttempts').textContent = gameState.nairaChase.attempts;
        }

        // Show/hide game containers
        function showGame(gameName) {
            // Hide all game containers
            document.querySelectorAll('.game-container').forEach(container => {
                container.style.display = 'none';
            });
            
            // Show the selected game container
            if (gameName) {
                document.getElementById(`${gameName}GameContainer`).style.display = 'block';
            }
        }

        // ========================
        // GAME IMPLEMENTATIONS
        // ========================
        
        // Memory Game
        const memoryGame = {
            init: function() {
                this.cards = ['A', 'A', 'B', 'B', 'C', 'C', 'D', 'D', 'E', 'E', 'F', 'F', 'G', 'G', 'H', 'H'];
                this.shuffledCards = [];
                this.flippedCards = [];
                this.matchedPairs = 0;
                this.gameStarted = false;
                this.currentWin = 0;
                
                document.getElementById('startMemoryGame').addEventListener('click', () => {
                    if (gameState.memory.attempts <= 0) {
                        alert('No more attempts left for Memory Game!');
                        return;
                    }
                    
                    this.startGame();
                });
            },
            
            startGame: function() {
                if (this.gameStarted) return;
                
                this.shuffledCards = this.shuffleCards([...this.cards]);
                this.flippedCards = [];
                this.matchedPairs = 0;
                this.currentWin = 0;
                this.gameStarted = true;
                
                document.getElementById('memoryMatches').textContent = '0';
                document.getElementById('memoryCurrentWin').textContent = '0';
                
                const gameBoard = document.getElementById('memoryGameBoard');
                gameBoard.innerHTML = '';
                
                this.shuffledCards.forEach((card, index) => {
                    const cardElement = document.createElement('div');
                    cardElement.className = 'memory-card';
                    cardElement.dataset.index = index;
                    cardElement.dataset.value = card;
                    cardElement.style.backgroundColor = '#3498db';
                    cardElement.style.color = 'white';
                    cardElement.style.display = 'flex';
                    cardElement.style.justifyContent = 'center';
                    cardElement.style.alignItems = 'center';
                    cardElement.style.height = '80px';
                    cardElement.style.borderRadius = '5px';
                    cardElement.style.cursor = 'pointer';
                    cardElement.style.fontSize = '24px';
                    cardElement.style.fontWeight = 'bold';
                    
                    cardElement.addEventListener('click', () => this.flipCard(cardElement));
                    
                    gameBoard.appendChild(cardElement);
                });
            },
            
            shuffleCards: function(cards) {
                for (let i = cards.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [cards[i], cards[j]] = [cards[j], cards[i]];
                }
                return cards;
            },
            
            flipCard: function(cardElement) {
                if (!this.gameStarted || this.flippedCards.length >= 2 || cardElement.textContent !== '') {
                    return;
                }
                
                // Play flip sound
                document.getElementById('flipSound').currentTime = 0;
                document.getElementById('flipSound').play();
                
                const index = parseInt(cardElement.dataset.index);
                const value = cardElement.dataset.value;
                
                cardElement.textContent = value;
                cardElement.style.backgroundColor = '#f1c40f';
                
                this.flippedCards.push({ index, value, element: cardElement });
                
                if (this.flippedCards.length === 2) {
                    this.checkForMatch();
                }
            },
            
            checkForMatch: function() {
                const [card1, card2] = this.flippedCards;
                
                if (card1.value === card2.value) {
                    // Match found
                    this.matchedPairs++;
                    this.currentWin += 100;
                    
                    document.getElementById('memoryMatches').textContent = this.matchedPairs;
                    document.getElementById('memoryCurrentWin').textContent = this.currentWin;
                    
                    // Play win sound
                    document.getElementById('winSound').currentTime = 0;
                    document.getElementById('winSound').play();
                    
                    // Mark cards as matched
                    card1.element.style.backgroundColor = '#2ecc71';
                    card2.element.style.backgroundColor = '#2ecc71';
                    card1.element.style.cursor = 'default';
                    card2.element.style.cursor = 'default';
                    
                    this.flippedCards = [];
                    
                    // Check if all pairs are matched
                    if (this.matchedPairs === 8) {
                        this.currentWin += 500; // Bonus for completing all pairs
                        document.getElementById('memoryCurrentWin').textContent = this.currentWin;
                        
                        setTimeout(() => {
                            alert(`Congratulations! You won ₦${this.currentWin}!`);
                            gameState.memory.wins++;
                            gameState.memory.earnings += this.currentWin;
                            updateBalance(this.currentWin);
                            gameState.memory.attempts--;
                            updateGameUI();
                            this.gameStarted = false;
                        }, 500);
                    }
                } else {
                    // No match
                    setTimeout(() => {
                        card1.element.textContent = '';
                        card2.element.textContent = '';
                        card1.element.style.backgroundColor = '#3498db';
                        card2.element.style.backgroundColor = '#3498db';
                        
                        this.flippedCards = [];
                    }, 1000);
                }
            }
        };
        
        // Dice Game
        const diceGame = {
            init: function() {
                this.currentGuess = null;
                this.lastResult = null;
                this.totalWinnings = 0;
                
                document.getElementById('rollDice').addEventListener('click', () => {
                    if (gameState.dice.attempts <= 0) {
                        alert('No more attempts left for Dice Game!');
                        return;
                    }
                    
                    if (!this.currentGuess) {
                        alert('Please make a guess first!');
                        return;
                    }
                    
                    this.rollDice();
                });
                
                document.getElementById('guessHigher').addEventListener('click', () => {
                    this.currentGuess = 'higher';
                    document.getElementById('clickSound').play();
                });
                
                document.getElementById('guessLower').addEventListener('click', () => {
                    this.currentGuess = 'lower';
                    document.getElementById('clickSound').play();
                });
                
                document.getElementById('guessSeven').addEventListener('click', () => {
                    this.currentGuess = 'seven';
                    document.getElementById('clickSound').play();
                });
            },
            
            rollDice: function() {
                // Play dice roll sound
                document.getElementById('coinFlipSound').play();
                
                // Disable buttons during roll
                document.getElementById('rollDice').disabled = true;
                document.getElementById('guessHigher').disabled = true;
                document.getElementById('guessLower').disabled = true;
                document.getElementById('guessSeven').disabled = true;
                
                // Animate dice
                const dice1 = document.getElementById('dice1');
                const dice2 = document.getElementById('dice2');
                
                let rolls = 0;
                const maxRolls = 10;
                const rollInterval = setInterval(() => {
                    const val1 = Math.floor(Math.random() * 6) + 1;
                    const val2 = Math.floor(Math.random() * 6) + 1;
                    
                    dice1.textContent = this.getDiceFace(val1);
                    dice2.textContent = this.getDiceFace(val2);
                    
                    rolls++;
                    if (rolls >= maxRolls) {
                        clearInterval(rollInterval);
                        
                        // Play landing sound
                        document.getElementById('coinLandSound').play();
                        
                        // Final values
                        const finalVal1 = Math.floor(Math.random() * 6) + 1;
                        const finalVal2 = Math.floor(Math.random() * 6) + 1;
                        const sum = finalVal1 + finalVal2;
                        
                        dice1.textContent = this.getDiceFace(finalVal1);
                        dice2.textContent = this.getDiceFace(finalVal2);
                        
                        // Determine result
                        let result = '';
                        let winAmount = 0;
                        
                        if (this.currentGuess === 'higher' && sum > 7) {
                            result = 'WIN! Sum is higher than 7';
                            winAmount = 200;
                        } else if (this.currentGuess === 'lower' && sum < 7) {
                            result = 'WIN! Sum is lower than 7';
                            winAmount = 200;
                        } else if (this.currentGuess === 'seven' && sum === 7) {
                            result = 'BIG WIN! Sum is exactly 7';
                            winAmount = 600;
                        } else {
                            result = `LOSE! Sum is ${sum}`;
                        }
                        
                        // Update UI
                        document.getElementById('diceLastResult').textContent = result;
                        
                        if (winAmount > 0) {
                            gameState.dice.wins++;
                            this.totalWinnings += winAmount;
                            document.getElementById('diceWins').textContent = gameState.dice.wins;
                            document.getElementById('diceTotalWinnings').textContent = this.totalWinnings;
                            
                            // Play win sound
                            document.getElementById('winSound').currentTime = 0;
                            document.getElementById('winSound').play();
                            
                            updateBalance(winAmount);
                            gameState.dice.earnings += winAmount;
                        } else {
                            // Play lose sound
                            document.getElementById('loseSound').currentTime = 0;
                            document.getElementById('loseSound').play();
                        }
                        
                        gameState.dice.attempts--;
                        updateGameUI();
                        
                        // Re-enable buttons
                        document.getElementById('rollDice').disabled = false;
                        document.getElementById('guessHigher').disabled = false;
                        document.getElementById('guessLower').disabled = false;
                        document.getElementById('guessSeven').disabled = false;
                        
                        this.currentGuess = null;
                        this.lastResult = result;
                    }
                }, 100);
            },
            
            getDiceFace: function(value) {
                const diceFaces = [
                    '⚀', '⚁', '⚂', '⚃', '⚄', '⚅'
                ];
                return diceFaces[value - 1];
            }
        };
        
        // Snake Game
        const snakeGame = {
            init: function() {
                this.canvas = document.getElementById('snakeCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.snake = [];
                this.food = {};
                this.direction = 'right';
                this.gameInterval = null;
                this.score = 0;
                this.highScore = 0;
                this.gameActive = false;
                
                document.getElementById('startSnakeGame').addEventListener('click', () => {
                    if (gameState.snake.attempts <= 0) {
                        alert('No more attempts left for Snake Game!');
                        return;
                    }
                    
                    this.startGame();
                });
                
                // Keyboard controls
                document.addEventListener('keydown', (e) => {
                    if (!this.gameActive) return;
                    
                    switch(e.key) {
                        case 'ArrowUp':
                            if (this.direction !== 'down') this.direction = 'up';
                            break;
                        case 'ArrowDown':
                            if (this.direction !== 'up') this.direction = 'down';
                            break;
                        case 'ArrowLeft':
                            if (this.direction !== 'right') this.direction = 'left';
                            break;
                        case 'ArrowRight':
                            if (this.direction !== 'left') this.direction = 'right';
                            break;
                    }
                });
            },
            
            startGame: function() {
                if (this.gameActive) return;
                
                // Initialize snake
                this.snake = [
                    {x: 200, y: 200},
                    {x: 190, y: 200},
                    {x: 180, y: 200},
                    {x: 170, y: 200},
                    {x: 160, y: 200}
                ];
                
                this.direction = 'right';
                this.score = 0;
                this.gameActive = true;
                
                document.getElementById('snakeScore').textContent = '0';
                document.getElementById('snakeEarnings').textContent = '0';
                
                // Generate first food
                this.generateFood();
                
                // Start game loop
                if (this.gameInterval) clearInterval(this.gameInterval);
                this.gameInterval = setInterval(() => this.gameLoop(), 100);
            },
            
            gameLoop: function() {
                // Clear canvas
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Draw snake
                this.ctx.fillStyle = '#2ecc71';
                this.snake.forEach(segment => {
                    this.ctx.fillRect(segment.x, segment.y, 10, 10);
                    this.ctx.strokeStyle = '#27ae60';
                    this.ctx.strokeRect(segment.x, segment.y, 10, 10);
                });
                
                // Draw food
                this.ctx.fillStyle = '#e74c3c';
                this.ctx.fillRect(this.food.x, this.food.y, 10, 10);
                
                // Move snake
                const head = {x: this.snake[0].x, y: this.snake[0].y};
                
                switch(this.direction) {
                    case 'up':
                        head.y -= 10;
                        break;
                    case 'down':
                        head.y += 10;
                        break;
                    case 'left':
                        head.x -= 10;
                        break;
                    case 'right':
                        head.x += 10;
                        break;
                }
                
                // Check collision with walls
                if (head.x < 0 || head.x >= this.canvas.width || head.y < 0 || head.y >= this.canvas.height) {
                    this.gameOver();
                    return;
                }
                
                // Check collision with self
                for (let i = 0; i < this.snake.length; i++) {
                    if (head.x === this.snake[i].x && head.y === this.snake[i].y) {
                        this.gameOver();
                        return;
                    }
                }
                
                // Check if snake ate food
                if (head.x === this.food.x && head.y === this.food.y) {
                    // Play win sound
                    document.getElementById('winSound').currentTime = 0;
                    document.getElementById('winSound').play();
                    
                    this.score++;
                    document.getElementById('snakeScore').textContent = this.score;
                    
                    // Add earnings
                    const earnings = this.score * 10;
                    if (this.score % 10 === 0) earnings += 100; // Bonus every 10 foods
                    gameState.snake.earnings = earnings;
                    document.getElementById('snakeEarnings').textContent = earnings;
                    
                    // Generate new food
                    this.generateFood();
                } else {
                    // Remove tail if no food eaten
                    this.snake.pop();
                }
                
                // Add new head
                this.snake.unshift(head);
            },
            
            generateFood: function() {
                this.food = {
                    x: Math.floor(Math.random() * (this.canvas.width / 10)) * 10,
                    y: Math.floor(Math.random() * (this.canvas.height / 10)) * 10
                };
                
                // Make sure food doesn't appear on snake
                for (let i = 0; i < this.snake.length; i++) {
                    if (this.snake[i].x === this.food.x && this.snake[i].y === this.food.y) {
                        this.generateFood();
                        return;
                    }
                }
            },
            
            gameOver: function() {
                clearInterval(this.gameInterval);
                this.gameActive = false;
                
                // Play lose sound
                document.getElementById('loseSound').currentTime = 0;
                document.getElementById('loseSound').play();
                
                // Update high score
                if (this.score > this.highScore) {
                    this.highScore = this.score;
                    document.getElementById('snakeHighScore').textContent = this.highScore;
                }
                
                // Update game state
                gameState.snake.score = Math.max(gameState.snake.score, this.score);
                gameState.snake.earnings = this.score * 10 + Math.floor(this.score / 10) * 100;
                updateBalance(gameState.snake.earnings);
                gameState.snake.attempts--;
                updateGameUI();
                
                alert(`Game Over! Your score: ${this.score}. You earned ₦${gameState.snake.earnings}`);
            }
        };
        
        // Trivia Game
        const triviaGame = {
            init: function() {
                this.questions = [
                    {
                        question: "What is the capital of Nigeria?",
                        options: ["Lagos", "Abuja", "Kano", "Ibadan"],
                        answer: "Abuja"
                    },
                    {
                        question: "Which planet is known as the Red Planet?",
                        options: ["Venus", "Mars", "Jupiter", "Saturn"],
                        answer: "Mars"
                    },
                    {
                        question: "What is the largest mammal in the world?",
                        options: ["Elephant", "Blue Whale", "Giraffe", "Polar Bear"],
                        answer: "Blue Whale"
                    },
                    {
                        question: "Which country is home to the kangaroo?",
                        options: ["South Africa", "Brazil", "Australia", "New Zealand"],
                        answer: "Australia"
                    },
                    {
                        question: "What is the currency of Japan?",
                        options: ["Won", "Yen", "Ringgit", "Baht"],
                        answer: "Yen"
                    },
                    {
                        question: "Which Nigerian musician is known as the 'African Giant'?",
                        options: ["Wizkid", "Davido", "Burna Boy", "Tiwa Savage"],
                        answer: "Burna Boy"
                    },
                    {
                        question: "What is the main component of the sun?",
                        options: ["Liquid lava", "Hydrogen", "Oxygen", "Carbon"],
                        answer: "Hydrogen"
                    },
                    {
                        question: "Which year did Nigeria gain independence?",
                        options: ["1957", "1960", "1963", "1970"],
                        answer: "1960"
                    },
                    {
                        question: "What is the largest ocean on Earth?",
                        options: ["Atlantic Ocean", "Indian Ocean", "Arctic Ocean", "Pacific Ocean"],
                        answer: "Pacific Ocean"
                    },
                    {
                        question: "Which Nigerian city is known as the 'Centre of Excellence'?",
                        options: ["Abuja", "Port Harcourt", "Lagos", "Enugu"],
                        answer: "Lagos"
                    }
                ];
                
                this.currentQuestion = null;
                this.correctAnswers = 0;
                this.totalWinnings = 0;
                
                document.getElementById('startTriviaGame').addEventListener('click', () => {
                    if (gameState.trivia.attempts <= 0) {
                        alert('No more attempts left for Trivia Game!');
                        return;
                    }
                    
                    this.startGame();
                });
            },
            
            startGame: function() {
                this.correctAnswers = 0;
                this.totalWinnings = 0;
                
                document.getElementById('triviaCorrect').textContent = '0';
                document.getElementById('triviaTotalWinnings').textContent = '0';
                
                this.nextQuestion();
            },
            
            nextQuestion: function() {
                // Filter out used questions
                const availableQuestions = this.questions.filter(q => 
                    !gameState.trivia.usedQuestions.includes(this.questions.indexOf(q))
                );
                
                if (availableQuestions.length === 0 || gameState.trivia.usedQuestions.length >= 10) {
                    // No more questions or max attempts reached
                    alert(`Game Over! You answered ${this.correctAnswers} questions correctly and earned ₦${this.totalWinnings}`);
                    
                    gameState.trivia.correct = this.correctAnswers;
                    gameState.trivia.earnings = this.totalWinnings;
                    updateBalance(this.totalWinnings);
                    gameState.trivia.attempts--;
                    updateGameUI();
                    
                    return;
                }
                
                // Select random question
                const randomIndex = Math.floor(Math.random() * availableQuestions.length);
                this.currentQuestion = availableQuestions[randomIndex];
                
                // Mark question as used
                gameState.trivia.usedQuestions.push(this.questions.indexOf(this.currentQuestion));
                
                // Display question
                document.getElementById('triviaQuestion').textContent = this.currentQuestion.question;
                
                // Display options
                const optionsContainer = document.getElementById('triviaOptions');
                optionsContainer.innerHTML = '';
                
                this.currentQuestion.options.forEach(option => {
                    const button = document.createElement('button');
                    button.className = 'btn';
                    button.style.margin = '5px';
                    button.textContent = option;
                    
                    button.addEventListener('click', () => {
                        document.getElementById('clickSound').play();
                        this.checkAnswer(option);
                    });
                    
                    optionsContainer.appendChild(button);
                });
            },
            
            checkAnswer: function(selectedOption) {
                if (selectedOption === this.currentQuestion.answer) {
                    // Correct answer
                    this.correctAnswers++;
                    const winAmount = 150;
                    this.totalWinnings += winAmount;
                    
                    document.getElementById('triviaCorrect').textContent = this.correctAnswers;
                    document.getElementById('triviaTotalWinnings').textContent = this.totalWinnings;
                    
                    // Play win sound
                    document.getElementById('winSound').currentTime = 0;
                    document.getElementById('winSound').play();
                    
                    // Show correct feedback
                    alert('Correct!');
                } else {
                    // Wrong answer
                    // Play lose sound
                    document.getElementById('loseSound').currentTime = 0;
                    document.getElementById('loseSound').play();
                    
                    // Show correct answer
                    alert(`Wrong! The correct answer is: ${this.currentQuestion.answer}`);
                }
                
                // Move to next question
                setTimeout(() => this.nextQuestion(), 1000);
            }
        };
        
        // Wheel Game
        const wheelGame = {
            init: function() {
                this.canvas = document.getElementById('wheelCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.prizes = [50, 100, 150, 200, 250, 300, 350, 400, 450, 500, 750, 1000];
                this.spinning = false;
                this.totalWinnings = 0;
                
                document.getElementById('spinWheel').addEventListener('click', () => {
                    if (gameState.wheel.attempts <= 0) {
                        alert('No more attempts left for Wheel Game!');
                        return;
                    }
                    
                    if (this.spinning) return;
                    
                    this.spinWheel();
                });
                
                // Draw initial wheel
                this.drawWheel();
            },
            
            drawWheel: function() {
                const centerX = this.canvas.width / 2;
                const centerY = this.canvas.height / 2;
                const radius = 150;
                const sliceAngle = (2 * Math.PI) / this.prizes.length;
                
                // Clear canvas
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Draw wheel slices
                for (let i = 0; i < this.prizes.length; i++) {
                    const startAngle = i * sliceAngle;
                    const endAngle = (i + 1) * sliceAngle;
                    
                    // Alternate colors
                    this.ctx.fillStyle = i % 2 === 0 ? '#3498db' : '#e74c3c';
                    this.ctx.strokeStyle = '#2c3e50';
                    this.ctx.lineWidth = 2;
                    
                    // Draw slice
                    this.ctx.beginPath();
                    this.ctx.moveTo(centerX, centerY);
                    this.ctx.arc(centerX, centerY, radius, startAngle, endAngle);
                    this.ctx.closePath();
                    this.ctx.fill();
                    this.ctx.stroke();
                    
                    // Draw prize text
                    this.ctx.save();
                    this.ctx.translate(centerX, centerY);
                    this.ctx.rotate(startAngle + sliceAngle / 2);
                    this.ctx.textAlign = 'right';
                    this.ctx.fillStyle = 'white';
                    this.ctx.font = 'bold 12px Arial';
                    this.ctx.fillText(`₦${this.prizes[i]}`, radius - 10, 5);
                    this.ctx.restore();
                }
                
                // Draw center circle
                this.ctx.fillStyle = '#f1c40f';
                this.ctx.beginPath();
                this.ctx.arc(centerX, centerY, 20, 0, 2 * Math.PI);
                this.ctx.fill();
                this.ctx.stroke();
                
                // Draw pointer
                this.ctx.fillStyle = '#2c3e50';
                this.ctx.beginPath();
                this.ctx.moveTo(centerX + radius + 10, centerY - 10);
                this.ctx.lineTo(centerX + radius + 10, centerY + 10);
                this.ctx.lineTo(centerX + radius + 30, centerY);
                this.ctx.closePath();
                this.ctx.fill();
            },
            
            spinWheel: function() {
                if (this.spinning) return;
                
                this.spinning = true;
                
                // Play spin sound
                document.getElementById('coinFlipSound').play();
                
                // Disable spin button
                document.getElementById('spinWheel').disabled = true;
                
                const centerX = this.canvas.width / 2;
                const centerY = this.canvas.height / 2;
                const radius = 150;
                
                let rotation = 0;
                let spins = 0;
                const maxSpins = 5 + Math.random() * 3; // 5-8 full spins
                const sliceAngle = (2 * Math.PI) / this.prizes.length;
                
                const spinInterval = setInterval(() => {
                    // Clear and redraw wheel with rotation
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    this.ctx.save();
                    this.ctx.translate(centerX, centerY);
                    this.ctx.rotate(rotation);
                    this.ctx.translate(-centerX, -centerY);
                    
                    // Draw wheel with current rotation
                    this.drawWheel();
                    
                    this.ctx.restore();
                    
                    // Draw pointer (not rotated)
                    this.ctx.fillStyle = '#2c3e50';
                    this.ctx.beginPath();
                    this.ctx.moveTo(centerX + radius + 10, centerY - 10);
                    this.ctx.lineTo(centerX + radius + 10, centerY + 10);
                    this.ctx.lineTo(centerX + radius + 30, centerY);
                    this.ctx.closePath();
                    this.ctx.fill();
                    
                    // Update rotation
                    rotation += 0.1;
                    if (rotation >= 2 * Math.PI) {
                        rotation = 0;
                        spins++;
                    }
                    
                    // Check if spinning should stop
                    if (spins >= maxSpins) {
                        clearInterval(spinInterval);
                        
                        // Play landing sound
                        document.getElementById('coinLandSound').play();
                        
                        // Determine prize
                        const winningAngle = (rotation + Math.PI) % (2 * Math.PI); // Adjust for pointer at top
                        const prizeIndex = Math.floor(winningAngle / sliceAngle);
                        const prize = this.prizes[prizeIndex];
                        
                        // Update UI
                        this.totalWinnings += prize;
                        gameState.wheel.wins++;
                        gameState.wheel.earnings += prize;
                        updateBalance(prize);
                        gameState.wheel.attempts--;
                        updateGameUI();
                        
                        document.getElementById('wheelLastWin').textContent = prize;
                        document.getElementById('wheelTotalWinnings').textContent = this.totalWinnings;
                        
                        // Play win sound
                        document.getElementById('winSound').currentTime = 0;
                        document.getElementById('winSound').play();
                        
                        // Re-enable spin button
                        document.getElementById('spinWheel').disabled = false;
                        this.spinning = false;
                        
                        alert(`Congratulations! You won ₦${prize}!`);
                    }
                }, 30);
            }
        };
        
        // Ayo Game (Ayo Olopon - traditional Nigerian game)
        const ayoGame = {
            init: function() {
                this.board = [4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4]; // 12 pits (6 per player)
                this.playerTurn = true; // Player 1 starts
                this.playerScore = 0;
                this.computerScore = 0;
                this.gameActive = false;
                
                document.getElementById('startAyoGame').addEventListener('click', () => {
                    if (gameState.ayo.attempts <= 0) {
                        alert('No more attempts left for Ayo Game!');
                        return;
                    }
                    
                    this.startGame();
                });
            },
            
            startGame: function() {
                if (this.gameActive) return;
                
                // Reset board
                this.board = [4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4];
                this.playerTurn = true;
                this.playerScore = 0;
                this.computerScore = 0;
                this.gameActive = true;
                
                document.getElementById('ayoPlayerScore').textContent = '0';
                document.getElementById('ayoComputerScore').textContent = '0';
                
                this.updateBoard();
                
                // Add event listeners to pits
                const pits = document.querySelectorAll('#ayoBoard > div');
                pits.forEach((pit, index) => {
                    if (index < 6) { // Only player's pits are clickable
                        pit.addEventListener('click', () => {
                            if (this.playerTurn && this.gameActive) {
                                this.makeMove(index);
                            }
                        });
                    }
                });
            },
            
            updateBoard: function() {
                const boardElement = document.getElementById('ayoBoard');
                boardElement.innerHTML = '';
                
                this.board.forEach((seeds, index) => {
                    const pit = document.createElement('div');
                    pit.className = 'ayo-pit';
                    pit.style.border = '1px solid #ddd';
                    pit.style.borderRadius = '50%';
                    pit.style.display = 'flex';
                    pit.style.justifyContent = 'center';
                    pit.style.alignItems = 'center';
                    pit.style.height = '50px';
                    pit.style.cursor = index < 6 && this.playerTurn ? 'pointer' : 'default';
                    pit.style.backgroundColor = index < 6 ? '#e6f7ff' : '#fff5e6';
                    
                    // Add seeds
                    for (let i = 0; i < seeds; i++) {
                        const seed = document.createElement('div');
                        seed.style.width = '8px';
                        seed.style.height = '8px';
                        seed.style.backgroundColor = '#8b4513';
                        seed.style.borderRadius = '50%';
                        seed.style.margin = '1px';
                        pit.appendChild(seed);
                    }
                    
                    boardElement.appendChild(pit);
                });
            },
            
            makeMove: function(pitIndex) {
                if (!this.gameActive || !this.playerTurn || this.board[pitIndex] === 0) return;
                
                // Play click sound
                document.getElementById('clickSound').play();
                
                let seeds = this.board[pitIndex];
                this.board[pitIndex] = 0;
                let currentIndex = pitIndex;
                
                // Distribute seeds
                while (seeds > 0) {
                    currentIndex = (currentIndex + 1) % 12;
                    if (currentIndex !== pitIndex) { // Skip the original pit
                        this.board[currentIndex]++;
                        seeds--;
                    }
                }
                
                // Check for capture
                while (currentIndex >= 6 && currentIndex < 12 && 
                      (this.board[currentIndex] === 2 || this.board[currentIndex] === 3)) {
                    this.playerScore += this.board[currentIndex];
                    this.board[currentIndex] = 0;
                    currentIndex--;
                }
                
                // Update UI
                this.updateBoard();
                document.getElementById('ayoPlayerScore').textContent = this.playerScore;
                
                // Check for game end
                if (this.isGameOver()) {
                    this.endGame();
                    return;
                }
                
                // Computer's turn
                this.playerTurn = false;
                setTimeout(() => this.computerMove(), 1000);
            },
            
            computerMove: function() {
                if (!this.gameActive || this.playerTurn) return;
                
                // Simple AI: choose pit with most seeds in computer's side
                let maxSeeds = 0;
                let selectedPit = -1;
                
                for (let i = 6; i < 12; i++) {
                    if (this.board[i] > maxSeeds) {
                        maxSeeds = this.board[i];
                        selectedPit = i;
                    }
                }
                
                if (selectedPit === -1) {
                    // No valid moves, end game
                    this.endGame();
                    return;
                }
                
                let seeds = this.board[selectedPit];
                this.board[selectedPit] = 0;
                let currentIndex = selectedPit;
                
                // Distribute seeds
                while (seeds > 0) {
                    currentIndex = (currentIndex + 1) % 12;
                    if (currentIndex !== selectedPit) { // Skip the original pit
                        this.board[currentIndex]++;
                        seeds--;
                    }
                }
                
                // Check for capture
                while (currentIndex >= 0 && currentIndex < 6 && 
                      (this.board[currentIndex] === 2 || this.board[currentIndex] === 3)) {
                    this.computerScore += this.board[currentIndex];
                    this.board[currentIndex] = 0;
                    currentIndex--;
                }
                
                // Update UI
                this.updateBoard();
                document.getElementById('ayoComputerScore').textContent = this.computerScore;
                
                // Check for game end
                if (this.isGameOver()) {
                    this.endGame();
                    return;
                }
                
                // Player's turn
                this.playerTurn = true;
            },
            
            isGameOver: function() {
                // Check if any side is empty
                const playerSideEmpty = this.board.slice(0, 6).every(seeds => seeds === 0);
                const computerSideEmpty = this.board.slice(6, 12).every(seeds => seeds === 0);
                
                return playerSideEmpty || computerSideEmpty;
            },
            
            endGame: function() {
                this.gameActive = false;
                
                // Collect remaining seeds
                const remainingSeeds = this.board.reduce((sum, seeds) => sum + seeds, 0);
                if (remainingSeeds > 0) {
                    if (this.playerScore > this.computerScore) {
                        this.playerScore += remainingSeeds;
                    } else if (this.computerScore > this.playerScore) {
                        this.computerScore += remainingSeeds;
                    } else {
                        // Split evenly if tie
                        this.playerScore += Math.floor(remainingSeeds / 2);
                        this.computerScore += Math.ceil(remainingSeeds / 2);
                    }
                }
                
                // Update final scores
                document.getElementById('ayoPlayerScore').textContent = this.playerScore;
                document.getElementById('ayoComputerScore').textContent = this.computerScore;
                
                // Determine winner
                let winAmount = 0;
                if (this.playerScore > this.computerScore) {
                    // Play win sound
                    document.getElementById('winSound').currentTime = 0;
                    document.getElementById('winSound').play();
                    
                    winAmount = 300;
                    gameState.ayo.wins++;
                    alert(`You win! Score: ${this.playerScore}-${this.computerScore}. You earned ₦${winAmount}`);
                } else if (this.computerScore > this.playerScore) {
                    // Play lose sound
                    document.getElementById('loseSound').currentTime = 0;
                    document.getElementById('loseSound').play();
                    
                    alert(`Computer wins! Score: ${this.computerScore}-${this.playerScore}`);
                } else {
                    alert(`It's a tie! Score: ${this.playerScore}-${this.computerScore}`);
                }
                
                // Update game state
                gameState.ayo.earnings += winAmount;
                updateBalance(winAmount);
                gameState.ayo.attempts--;
                updateGameUI();
            }
        };
        
        // Naira Chase Game
        const nairaChaseGame = {
            init: function() {
                this.canvas = document.getElementById('nairaChaseCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.player = {
                    x: this.canvas.width / 2 - 25,
                    y: this.canvas.height - 50,
                    width: 50,
                    height: 50,
                    speed: 10
                };
                this.nairaNotes = [];
                this.gameActive = false;
                this.score = 0;
                this.earnings = 0;
                this.gameInterval = null;
                
                document.getElementById('startNairaChase').addEventListener('click', () => {
                    if (gameState.nairaChase.attempts <= 0) {
                        alert('No more attempts left for Naira Chase!');
                        return;
                    }
                    
                    this.startGame();
                });
                
                // Keyboard controls
                document.addEventListener('keydown', (e) => {
                    if (!this.gameActive) return;
                    
                    switch(e.key) {
                        case 'ArrowLeft':
                            this.player.x = Math.max(0, this.player.x - this.player.speed);
                            break;
                        case 'ArrowRight':
                            this.player.x = Math.min(this.canvas.width - this.player.width, this.player.x + this.player.speed);
                            break;
                    }
                });
            },
            
            startGame: function() {
                if (this.gameActive) return;
                
                this.player = {
                    x: this.canvas.width / 2 - 25,
                    y: this.canvas.height - 50,
                    width: 50,
                    height: 50,
                    speed: 10
                };
                this.nairaNotes = [];
                this.score = 0;
                this.earnings = 0;
                this.gameActive = true;
                
                document.getElementById('nairaChaseScore').textContent = '0';
                document.getElementById('nairaChaseEarnings').textContent = '0';
                
                // Start game loop
                if (this.gameInterval) clearInterval(this.gameInterval);
                this.gameInterval = setInterval(() => this.gameLoop(), 30);
                
                // Start generating notes
                this.noteInterval = setInterval(() => {
                    if (this.gameActive) {
                        this.generateNote();
                    }
                }, 1000);
            },
            
            gameLoop: function() {
                // Clear canvas
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Draw player (basket)
                this.ctx.fillStyle = '#3498db';
                this.ctx.fillRect(this.player.x, this.player.y, this.player.width, this.player.height);
                
                // Draw naira notes
                this.ctx.fillStyle = '#27ae60';
                this.nairaNotes.forEach((note, index) => {
                    note.y += note.speed;
                    this.ctx.fillRect(note.x, note.y, note.width, note.height);
                    
                    // Check collision with player
                    if (note.y + note.height >= this.player.y &&
                        note.x + note.width >= this.player.x &&
                        note.x <= this.player.x + this.player.width) {
                        // Play win sound
                        document.getElementById('winSound').currentTime = 0;
                        document.getElementById('winSound').play();
                        
                        // Collect note
                        this.nairaNotes.splice(index, 1);
                        this.score++;
                        const noteValue = note.value;
                        this.earnings += noteValue;
                        
                        document.getElementById('nairaChaseScore').textContent = this.score;
                        document.getElementById('nairaChaseEarnings').textContent = this.earnings;
                    }
                    
                    // Remove notes that fall off screen
                    if (note.y > this.canvas.height) {
                        this.nairaNotes.splice(index, 1);
                    }
                });
                
                // Check game over condition (time-based in this simple version)
                if (this.score >= 50) {
                    this.gameOver();
                }
            },
            
            generateNote: function() {
                const note = {
                    x: Math.random() * (this.canvas.width - 30),
                    y: 0,
                    width: 30,
                    height: 30,
                    speed: 3 + Math.random() * 3,
                    value: 10 + Math.floor(Math.random() * 90) // ₦10-₦100
                };
                
                this.nairaNotes.push(note);
            },
            
            gameOver: function() {
                clearInterval(this.gameInterval);
                clearInterval(this.noteInterval);
                this.gameActive = false;
                
                // Update game state
                gameState.nairaChase.score = this.score;
                gameState.nairaChase.earnings = this.earnings;
                updateBalance(this.earnings);
                gameState.nairaChase.attempts--;
                updateGameUI();
                
                alert(`Game Over! You caught ${this.score} notes and earned ₦${this.earnings}!`);
            }
        };
        
        // ========================
        // INITIALIZATION
        // ========================
        
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize game state
            const accessGranted = await initializeGameState();
            
            if (!accessGranted) return;
            
            // Show main game container
            document.getElementById('mainGameContainer').style.display = 'block';
            
            // Initialize games
            memoryGame.init();
            diceGame.init();
            snakeGame.init();
            triviaGame.init();
            wheelGame.init();
            ayoGame.init();
            nairaChaseGame.init();
            
            // Update UI with current state
            updateGameUI();
            document.getElementById('balanceDisplay').textContent = gameState.balance.toLocaleString();
            
            // Set up online/offline detection
            window.addEventListener('online', updateSyncStatus);
            window.addEventListener('offline', updateSyncStatus);
            
            function updateSyncStatus() {
                const statusEl = document.getElementById('syncStatus');
                if (navigator.onLine) {
                    statusEl.textContent = 'Online';
                    statusEl.className = 'sync-status online';
                } else {
                    statusEl.textContent = 'Offline - Changes saved locally';
                    statusEl.className = 'sync-status offline';
                }
            }
            
            // Initial sync check
            updateSyncStatus();
            
            // Game card click handlers
            document.querySelectorAll('.game-card').forEach(card => {
                card.addEventListener('click', () => {
                    showGame(card.dataset.game);
                });
            });
            
            // Back to games buttons
            document.getElementById('backToGames1').addEventListener('click', () => showGame(''));
            document.getElementById('backToGames2').addEventListener('click', () => showGame(''));
            document.getElementById('backToGames3').addEventListener('click', () => showGame(''));
            document.getElementById('backToGames4').addEventListener('click', () => showGame(''));
            document.getElementById('backToGames5').addEventListener('click', () => showGame(''));
            document.getElementById('backToGames6').addEventListener('click', () => showGame(''));
            document.getElementById('backToGames7').addEventListener('click', () => showGame(''));
            
            // Update FOMO timer
            setInterval(() => {
                const now = new Date();
                const minutes = now.getMinutes();
                const seconds = now.getSeconds();
                
                // Show different messages based on time
                if (minutes % 5 === 0 && seconds === 0) {
                    const messages = [
                        "🔥 PLAY NOW! Big wins happening!",
                        "⏳ LIMITED TIME! Spin the wheel!",
                        "💰 HIGH PAYOUTS! Don't miss out!",
                        "🎮 PLAYERS WINNING NOW! Join them!"
                    ];
                    const randomMsg = messages[Math.floor(Math.random() * messages.length)];
                    document.querySelector('.fomo-text').textContent = randomMsg;
                }
            }, 1000);
        });
    </script>
</body>
</html>
