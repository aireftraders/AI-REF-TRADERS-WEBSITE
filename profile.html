<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Nigeria-Focused SEO Meta Tags -->
    <meta name="description" content="AI REF-TRADERS: User Profile - Manage your account, view earnings, and track your referrals on Nigeria's premier AI trading platform.">
    <meta name="keywords" content="AI REF-TRADERS profile, Nigerian trading account, manage earnings Nigeria, Lagos trading profile, Abuja user account">
    <meta name="author" content="AI REF-TRADERS Nigeria">
    
    <!-- Nigeria Geo Targeting -->
    <meta name="geo.region" content="NG" />
    <meta name="geo.placename" content="Lagos" />
    <meta name="geo.position" content="6.524379;3.379206" />
    <meta name="ICBM" content="6.524379, 3.379206" />
    
    <!-- Open Graph / Social Media -->
    <meta property="og:title" content="User Profile - AI REF-TRADERS Nigeria">
    <meta property="og:description" content="Manage your AI trading account, view earnings, and track referrals on Nigeria's premier trading platform">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://aireftraders.ng/profile">
    <meta property="og:image" content="https://aireftraders.ng/images/profile-preview.jpg">
    <meta property="og:site_name" content="AI REF-TRADERS Nigeria">
    <meta property="og:locale" content="en_NG">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="User Profile - AI REF-TRADERS Nigeria">
    <meta name="twitter:description" content="Manage your AI trading account and track earnings on Nigeria's premier platform">
    <meta name="twitter:image" content="https://aireftraders.ng/images/profile-twitter-card.jpg">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://aireftraders.ng/profile" />
    
    <!-- Favicon -->
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    
    <title>My Profile - AI REF-TRADERS</title>
    <!-- Include Dexie.js for IndexedDB -->
    <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
    <style>
        :root {
            --primary: #6C5CE7;
            --secondary: #00CEFF;
            --dark: #2D3436;
            --light: #F5F6FA;
            --success: #00B894;
            --danger: #D63031;
            --warning: #FDCB6E;
            --nigerian-green: #008753;
            --nigerian-white: #FFFFFF;
            --nigerian-green-light: #E5F5EE;
            
            /* Theme variables */
            --bg-color: #F5F6FA;
            --text-color: #2D3436;
            --card-bg: #FFFFFF;
            --border-color: #e0e0e0;
            --shadow-color: rgba(0,0,0,0.1);
        }
        
        /* Dark theme variables */
        [data-theme="dark"] {
            --bg-color: #121212;
            --text-color: #E0E0E0;
            --card-bg: #1E1E1E;
            --border-color: #333333;
            --shadow-color: rgba(0,0,0,0.3);
            --dark: #E0E0E0;
            --light: #121212;
            --nigerian-green-light: #1E3D31;
        }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: all 0.3s;
        }
        
        .container {
            max-width: 100%;
            padding: 15px;
            padding-bottom: 70px;
        }
        
        .app-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        
        .user-chip {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: bold;
            background: var(--nigerian-green);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
        }
        
        /* Nigerian Flag Inspired Elements */
        .nigeria-badge {
            background: linear-gradient(to right, var(--nigerian-green) 33%, var(--nigerian-white) 33%, var(--nigerian-white) 66%, var(--nigerian-green) 66%);
            color: var(--dark);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
            margin-left: 5px;
        }
        
        /* Profile Header Styles */
        .profile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .profile-title {
            color: var(--primary);
            margin: 0;
            font-size: 24px;
        }
        
        .logout-btn {
            background-color: var(--danger);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }
        
        .logout-btn:hover {
            background-color: #c0392b;
        }
        
        /* Profile Section Styles */
        .profile-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px var(--shadow-color);
        }
        
        .section-title {
            color: var(--primary);
            margin-top: 0;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        /* Info Grid Layout */
        .info-grid {
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 15px 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 600px) {
            .info-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
        
        .info-label {
            font-weight: 600;
            color: var(--primary);
        }
        
        .info-value {
            color: var(--text-color);
        }
        
        .status-active {
            color: var(--success);
            font-weight: 600;
        }
        
        .status-inactive {
            color: var(--danger);
            font-weight: 600;
        }
        
        /* Login History Table */
        .login-history {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .login-history th {
            text-align: left;
            padding: 12px 15px;
            background: var(--bg-color);
            color: var(--text-color);
            font-weight: bold;
        }
        
        .login-history td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .login-history tr:last-child td {
            border-bottom: none;
        }
        
        /* Transaction History */
        .transaction-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .transaction-details {
            flex: 1;
        }
        
        .transaction-amount {
            font-weight: bold;
        }
        
        .transaction-positive {
            color: var(--success);
        }
        
        .transaction-negative {
            color: var(--danger);
        }
        
        /* Edit Profile Button */
        .edit-profile-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 20px;
            display: inline-block;
        }
        
        /* Theme Toggle Switch */
        .theme-toggle {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1100;
        }
        
        .theme-toggle-btn {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 8px 12px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 2px 5px var(--shadow-color);
        }
        
        .theme-toggle-btn:hover {
            background: var(--bg-color);
        }
        
        .theme-icon {
            font-size: 16px;
        }

        /* Navigation Bar */
        .navigation-bar {
            background-color: var(--primary);
            color: white;
            padding: 10px 0;
            position: fixed;
            bottom: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            box-shadow: 0 -2px 10px var(--shadow-color);
        }

        .navigation-bar ul {
            list-style: none;
            display: flex;
            gap: 15px;
            margin: 0;
            padding: 0;
        }

        .navigation-bar li {
            display: inline;
        }

        .navigation-bar a {
            color: white;
            text-decoration: none;
            font-weight: bold;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 12px;
        }

        .navigation-bar a:hover {
            background-color: var(--secondary);
        }

        .navigation-bar a.active {
            background-color: var(--secondary);
        }

        .nav-icon {
            font-size: 18px;
            margin-bottom: 3px;
        }

        /* Responsive Design */
        @media (max-width: 600px) {
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .navigation-bar ul {
                gap: 5px;
            }
            
            .navigation-bar a {
                padding: 5px 8px;
                font-size: 11px;
            }
            
            .nav-icon {
                font-size: 16px;
            }
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .modal.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .modal-content {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
            transform: translateY(20px);
            transition: transform 0.3s;
        }
        
        .modal.active .modal-content {
            transform: translateY(0);
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* Form Input Styles */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--primary);
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--card-bg);
            color: var(--text-color);
        }
        
        /* Notification Styles */
        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--success);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 3px 10px var(--shadow-color);
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .notification.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Theme Toggle Button -->
    <div class="theme-toggle">
        <button class="theme-toggle-btn" id="themeToggle">
            <span class="theme-icon" id="themeIcon">üåô</span>
            <span id="themeText">Dark Mode</span>
        </button>
    </div>

    <div class="container">
        <div class="app-bar">
            <h1>AI REF-TRADERS <span class="nigeria-badge">PROFILE</span></h1>
            <div class="user-chip">
                <span>üë§ <span id="usernameDisplay">User</span></span>
            </div>
        </div>
        
        <div class="profile-header">
            <h1 class="profile-title">My Profile</h1>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </div>
        
        <!-- Account Information Section -->
        <div class="profile-section">
            <h2 class="section-title">Account Information</h2>
            <div class="info-grid">
                <div class="info-label">Full Name:</div>
                <div class="info-value" id="fullName">Loading...</div>
                
                <div class="info-label">Email Address:</div>
                <div class="info-value" id="email">Loading...</div>
                
                <div class="info-label">Phone Number:</div>
                <div class="info-value" id="phone">Loading...</div>
                
                <div class="info-label">Account Created:</div>
                <div class="info-value" id="accountCreated">Loading...</div>
                
                <div class="info-label">Last Login:</div>
                <div class="info-value" id="lastLogin">Loading...</div>
                
                <div class="info-label">Referrals Completed:</div>
                <div class="info-value" id="referralsCompleted">Loading...</div>
                
                <div class="info-label">Account Status:</div>
                <div class="info-value" id="accountStatus">Loading...</div>
            </div>
            
            <button class="edit-profile-btn" id="editProfileBtn">Edit Profile</button>
        </div>
        
        <!-- Financial Information Section -->
        <div class="profile-section">
            <h2 class="section-title">Financial Information</h2>
            <div class="info-grid">
                <div class="info-label">Current Balance:</div>
                <div class="info-value" id="currentBalance">Loading...</div>
                
                <div class="info-label">Withdrawable Balance:</div>
                <div class="info-value" id="withdrawableBalance">Loading...</div>
                
                <div class="info-label">Total Profit:</div>
                <div class="info-value" id="totalProfit">Loading...</div>
                
                <div class="info-label">Total Withdrawn:</div>
                <div class="info-value" id="totalWithdrawn">Loading...</div>
                
                <div class="info-label">Trading Capital:</div>
                <div class="info-value" id="tradingCapital">Loading...</div>
                
                <div class="info-label">Daily Profit:</div>
                <div class="info-value" id="dailyProfit">Loading...</div>
            </div>
        </div>
        
        <!-- Bank Information Section -->
        <div class="profile-section">
            <h2 class="section-title">Bank Information</h2>
            <div class="info-grid">
                <div class="info-label">Bank Name:</div>
                <div class="info-value" id="bankName">Loading...</div>
                
                <div class="info-label">Account Number:</div>
                <div class="info-value" id="accountNumber">Loading...</div>
                
                <div class="info-label">Account Name:</div>
                <div class="info-value" id="bankAccountName">Loading...</div>
                
                <div class="info-label">Verification Status:</div>
                <div class="info-value" id="verificationStatus">Loading...</div>
            </div>
            
            <button class="edit-profile-btn" id="editBankBtn">Update Bank Details</button>
        </div>
        
        <!-- Login History Section -->
        <div class="profile-section">
            <h2 class="section-title">Login History</h2>
            <div class="info-grid">
                <div class="info-label">Current Session IP:</div>
                <div class="info-value" id="currentIp">Loading...</div>
                
                <div class="info-label">Current Device:</div>
                <div class="info-value" id="currentDevice">Loading...</div>
                
                <div class="info-label">Current Location:</div>
                <div class="info-value" id="currentLocation">Loading...</div>
            </div>
            
            <h3>Recent Login Activity</h3>
            <table class="login-history">
                <thead>
                    <tr>
                        <th>Date & Time</th>
                        <th>Device</th>
                        <th>Location</th>
                    </tr>
                </thead>
                <tbody id="loginHistoryBody">
                    <tr>
                        <td colspan="3">Loading login history...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Transaction History Section -->
        <div class="profile-section">
            <h2 class="section-title">Recent Transactions</h2>
            <div id="transactionHistory">
                <div class="transaction-item">
                    <div class="transaction-details">Loading transaction history...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Navigation Bar -->
    <nav class="navigation-bar">
        <ul>
            <li>
                <a href="index.html">
                    <span class="nav-icon">üìä</span>
                    <span>Dashboard</span>
                </a>
            </li>
            <li>
                <a href="trading.html">
                    <span class="nav-icon">ü§ñ</span>
                    <span>Trading</span>
                </a>
            </li>
            <li>
                <a href="ads.html">
                    <span class="nav-icon">üì∫</span>
                    <span>Ads</span>
                </a>
            </li>
            <li>
                <a href="profile.html" class="active">
                    <span class="nav-icon">üë§</span>
                    <span>Profile</span>
                </a>
            </li>
        </ul>
    </nav>
    
    <!-- Edit Profile Modal -->
    <div class="modal" id="editProfileModal">
        <div class="modal-content">
            <h3>Edit Profile</h3>
            <div class="form-group">
                <label for="editFullName">Full Name</label>
                <input type="text" id="editFullName" placeholder="Enter your full name">
            </div>
            <div class="form-group">
                <label for="editEmail">Email Address</label>
                <input type="email" id="editEmail" placeholder="Enter your email">
            </div>
            <div class="form-group">
                <label for="editPhone">Phone Number</label>
                <input type="tel" id="editPhone" placeholder="Enter your phone number">
            </div>
            <div class="modal-actions">
                <button class="primary" id="saveProfileBtn">Save Changes</button>
                <button class="secondary" id="cancelEditProfile">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Edit Bank Modal -->
    <div class="modal" id="editBankModal">
        <div class="modal-content">
            <h3>Update Bank Details</h3>
            <div class="form-group">
                <label for="editBankName">Bank Name</label>
                <select id="editBankName" class="form-group input">
                    <option value="">Select Bank</option>
                    <option value="access">Access Bank</option>
                    <option value="zenith">Zenith Bank</option>
                    <option value="gtb">GTBank</option>
                    <option value="uba">UBA</option>
                    <option value="firstbank">First Bank</option>
                    <option value="fidelity">Fidelity Bank</option>
                    <option value="union">Union Bank</option>
                    <option value="stanbic">Stanbic IBTC</option>
                    <option value="ecobank">Ecobank</option>
                    <option value="polaris">Polaris Bank</option>
                    <option value="fcmb">FCMB</option>
                    <option value="kuda">Kuda Bank</option>
                    <option value="opay">Opay</option>
                    <option value="palmpay">PalmPay</option>
                    <option value="moniepoint">Moniepoint</option>
                    <option value="other">Other Bank</option>
                </select>
            </div>
            <div class="form-group">
                <label for="editAccountNumber">Account Number</label>
                <input type="text" id="editAccountNumber" placeholder="Enter account number">
            </div>
            <div class="form-group">
                <label for="editAccountName">Account Name</label>
                <input type="text" id="editAccountName" placeholder="Account name will be verified" readonly>
            </div>
            <div class="modal-actions">
                <button class="primary" id="saveBankBtn">Save Bank Details</button>
                <button class="secondary" id="cancelEditBank">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Notification -->
    <div class="notification" id="notification">
        <span id="notificationText">Notification message</span>
    </div>
    
    <script>
        // Initialize Dexie database (same as index.html)
        const db = new Dexie("AI_REF_TRADERS_DB");
        
        // Define database schema (must match index.html)
        db.version(1).stores({
            users: '++id, email, phone, balance, referrals, adsWatched, totalAdsWatched, verified, tradingActive, tradingCapital, dailyProfit, totalProfit, withdrawableProfit, bankDetails, paymentCircle, gameEarnings, lastAdWatchTime, streak, announcements, referrer, fullName, accountCreated, lastLogin, loginHistory, transactions',
            announcements: '++id, title, content, time, unread',
            supportTickets: '++id, userId, subject, message, status, createdAt',
            adminCredentials: '++id, username, password',
            transactions: '++id, userId, type, amount, status, timestamp'
        });
        
        // Current user data
        let currentUser = null;
        
        // Format date for display
        function formatDate(dateString) {
            if (!dateString) return 'Not available';
            const date = new Date(dateString);
            return date.toLocaleString();
        }
        
        // Format currency for display
        function formatCurrency(amount) {
            return '‚Ç¶' + (amount || 0).toLocaleString();
        }
        
        // Show notification
        function showNotification(message) {
            const notification = document.getElementById('notification');
            document.getElementById('notificationText').textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Load user data from IndexedDB
        async function loadUserData() {
            try {
                const userEmail = localStorage.getItem('userEmail');
                const userPhone = localStorage.getItem('userPhone');
                
                if (!userEmail && !userPhone) {
                    // User not logged in, redirect to login
                    window.location.href = 'index.html';
                    return;
                }
                
                // Get user from database
                currentUser = await db.users.where('email').equals(userEmail).or('phone').equals(userPhone).first();
                
                if (!currentUser) {
                    // User not found, redirect to login
                    window.location.href = 'index.html';
                    return;
                }
                
                // Update UI with user data
                updateProfileUI();
                
            } catch (error) {
                console.error('Error loading user data:', error);
                showNotification('Error loading profile data');
            }
        }
        
        // Update profile UI with user data
        function updateProfileUI() {
            if (!currentUser) return;
            
            // Account Information
            document.getElementById('fullName').textContent = currentUser.fullName || 'Not set';
            document.getElementById('email').textContent = currentUser.email || 'Not set';
            document.getElementById('phone').textContent = currentUser.phone || 'Not set';
            document.getElementById('accountCreated').textContent = formatDate(currentUser.accountCreated);
            document.getElementById('lastLogin').textContent = formatDate(currentUser.lastLogin);
            document.getElementById('referralsCompleted').textContent = currentUser.referrals || 0;
            document.getElementById('accountStatus').textContent = currentUser.verified ? 'Verified' : 'Unverified';
            document.getElementById('accountStatus').className = currentUser.verified ? 'info-value status-active' : 'info-value status-inactive';
            
            // Financial Information
            document.getElementById('currentBalance').textContent = formatCurrency(currentUser.balance);
            document.getElementById('withdrawableBalance').textContent = formatCurrency(currentUser.withdrawableProfit);
            document.getElementById('totalProfit').textContent = formatCurrency(currentUser.totalProfit);
            
            // Calculate total withdrawn from transactions
            calculateTotalWithdrawn().then(total => {
                document.getElementById('totalWithdrawn').textContent = formatCurrency(total);
            });
            
            document.getElementById('tradingCapital').textContent = formatCurrency(currentUser.tradingCapital);
            document.getElementById('dailyProfit').textContent = formatCurrency(currentUser.dailyProfit);
            
            // Bank Information
            if (currentUser.bankDetails) {
                document.getElementById('bankName').textContent = currentUser.bankDetails.bankName || 'Not set';
                document.getElementById('accountNumber').textContent = currentUser.bankDetails.accountNumber || 'Not set';
                document.getElementById('bankAccountName').textContent = currentUser.bankDetails.accountName || 'Not set';
                document.getElementById('verificationStatus').textContent = currentUser.verified ? 'Verified' : 'Pending Verification';
                document.getElementById('verificationStatus').className = currentUser.verified ? 'info-value status-active' : 'info-value status-inactive';
            } else {
                document.getElementById('bankName').textContent = 'Not set';
                document.getElementById('accountNumber').textContent = 'Not set';
                document.getElementById('bankAccountName').textContent = 'Not set';
                document.getElementById('verificationStatus').textContent = 'Not verified';
                document.getElementById('verificationStatus').className = 'info-value status-inactive';
            }
            
            // Login Information
            document.getElementById('currentIp').textContent = getCurrentIp() || 'Unknown';
            document.getElementById('currentDevice').textContent = getDeviceInfo() || 'Unknown';
            document.getElementById('currentLocation').textContent = getLocationInfo() || 'Unknown';
            
            // Username display
            document.getElementById('usernameDisplay').textContent = currentUser.fullName ? currentUser.fullName.split(' ')[0] : 'User';
            
            // Load login history
            loadLoginHistory();
            
            // Load transaction history
            loadTransactionHistory();
        }
        
        // Calculate total withdrawn from transactions
        async function calculateTotalWithdrawn() {
            try {
                const userEmail = localStorage.getItem('userEmail');
                const userPhone = localStorage.getItem('userPhone');
                
                const withdrawals = await db.transactions
                    .where('userId').equals(userEmail || userPhone)
                    .and(transaction => transaction.type === 'withdrawal' && transaction.status === 'completed')
                    .toArray();
                
                return withdrawals.reduce((total, tx) => total + tx.amount, 0);
            } catch (error) {
                console.error('Error calculating total withdrawn:', error);
                return 0;
            }
        }
        
        // Get current IP (simulated)
        function getCurrentIp() {
            // In a real app, you would get this from the server or a service
            return '192.168.' + Math.floor(Math.random() * 255) + '.' + Math.floor(Math.random() * 255);
        }
        
        // Get device info
        function getDeviceInfo() {
            const userAgent = navigator.userAgent;
            
            if (userAgent.match(/Android/i)) {
                return 'Android Device';
            } else if (userAgent.match(/iPhone|iPad|iPod/i)) {
                return 'iOS Device';
            } else if (userAgent.match(/Windows/i)) {
                return 'Windows PC';
            } else if (userAgent.match(/Mac/i)) {
                return 'Mac';
            } else if (userAgent.match(/Linux/i)) {
                return 'Linux PC';
            } else {
                return 'Unknown Device';
            }
        }
        
        // Get location info (simulated)
        function getLocationInfo() {
            // In a real app, you would use geolocation or IP lookup
            const locations = ['Lagos, Nigeria', 'Abuja, Nigeria', 'Port Harcourt, Nigeria', 'Kano, Nigeria', 'Ibadan, Nigeria'];
            return locations[Math.floor(Math.random() * locations.length)];
        }
        
        // Load login history
        async function loadLoginHistory() {
            try {
                const loginHistoryBody = document.getElementById('loginHistoryBody');
                
                if (!currentUser.loginHistory || currentUser.loginHistory.length === 0) {
                    loginHistoryBody.innerHTML = '<tr><td colspan="3">No login history available</td></tr>';
                    return;
                }
                
                // Sort by most recent first
                const sortedHistory = [...currentUser.loginHistory].sort((a, b) => {
                    return new Date(b.loginTime) - new Date(a.loginTime);
                });
                
                // Display last 5 logins
                loginHistoryBody.innerHTML = '';
                sortedHistory.slice(0, 5).forEach(login => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${formatDate(login.loginTime)}</td>
                        <td>${login.device || 'Unknown'}</td>
                        <td>${login.location || 'Unknown'}</td>
                    `;
                    loginHistoryBody.appendChild(row);
                });
                
            } catch (error) {
                console.error('Error loading login history:', error);
                document.getElementById('loginHistoryBody').innerHTML = '<tr><td colspan="3">Error loading login history</td></tr>';
            }
        }
        
        // Load transaction history
        async function loadTransactionHistory() {
            try {
                const userEmail = localStorage.getItem('userEmail');
                const userPhone = localStorage.getItem('userPhone');
                
                const transactions = await db.transactions
                    .where('userId').equals(userEmail || userPhone)
                    .sortBy('timestamp');
                
                // Reverse to show most recent first
                transactions.reverse();
                
                const transactionHistory = document.getElementById('transactionHistory');
                transactionHistory.innerHTML = '';
                
                if (transactions.length === 0) {
                    transactionHistory.innerHTML = '<div class="transaction-item"><div class="transaction-details">No transactions yet</div></div>';
                    return;
                }
                
                // Display last 5 transactions
                transactions.slice(0, 5).forEach(tx => {
                    const item = document.createElement('div');
                    item.className = 'transaction-item';
                    
                    const details = document.createElement('div');
                    details.className = 'transaction-details';
                    
                    const amount = document.createElement('div');
                    amount.className = 'transaction-amount ' + 
                        (tx.type === 'deposit' || tx.type === 'profit' ? 'transaction-positive' : 'transaction-negative');
                    
                    // Format transaction details
                    let typeText = '';
                    switch (tx.type) {
                        case 'deposit':
                            typeText = 'Deposit';
                            break;
                        case 'withdrawal':
                            typeText = 'Withdrawal';
                            break;
                        case 'profit':
                            typeText = 'Trading Profit';
                            break;
                        case 'referral':
                            typeText = 'Referral Bonus';
                            break;
                        case 'game':
                            typeText = 'Game Earnings';
                            break;
                        default:
                            typeText = 'Transaction';
                    }
                    
                    details.textContent = `${typeText} - ${formatDate(tx.timestamp)}`;
                    amount.textContent = (tx.type === 'withdrawal' ? '-' : '+') + formatCurrency(tx.amount);
                    
                    item.appendChild(details);
                    item.appendChild(amount);
                    transactionHistory.appendChild(item);
                });
                
            } catch (error) {
                console.error('Error loading transaction history:', error);
                document.getElementById('transactionHistory').innerHTML = 
                    '<div class="transaction-item"><div class="transaction-details">Error loading transactions</div></div>';
            }
        }
        
        // Save profile changes
        async function saveProfileChanges() {
            try {
                const fullName = document.getElementById('editFullName').value.trim();
                const email = document.getElementById('editEmail').value.trim();
                const phone = document.getElementById('editPhone').value.trim();
                
                if (!fullName || !email || !phone) {
                    showNotification('Please fill in all fields');
                    return;
                }
                
                // Update user data
                currentUser.fullName = fullName;
                currentUser.email = email;
                currentUser.phone = phone;
                
                // Save to database
                await db.users.update(currentUser.id, {
                    fullName: fullName,
                    email: email,
                    phone: phone
                });
                
                // Update UI
                updateProfileUI();
                
                // Close modal
                document.getElementById('editProfileModal').classList.remove('active');
                
                showNotification('Profile updated successfully');
                
            } catch (error) {
                console.error('Error saving profile changes:', error);
                showNotification('Error updating profile');
            }
        }
        
        // Save bank details
        async function saveBankDetails() {
            try {
                const bankName = document.getElementById('editBankName').value;
                const accountNumber = document.getElementById('editAccountNumber').value.trim();
                const accountName = document.getElementById('editAccountName').value.trim();
                
                if (!bankName || !accountNumber || !accountName) {
                    showNotification('Please fill in all bank details');
                    return;
                }
                
                if (accountNumber.length !== 10) {
                    showNotification('Account number must be 10 digits');
                    return;
                }
                
                // Update user data
                currentUser.bankDetails = {
                    bankName: bankName,
                    accountNumber: accountNumber,
                    accountName: accountName
                };
                
                // Mark as unverified until payment is made
                currentUser.verified = false;
                
                // Save to database
                await db.users.update(currentUser.id, {
                    bankDetails: currentUser.bankDetails,
                    verified: false
                });
                
                // Update UI
                updateProfileUI();
                
                // Close modal
                document.getElementById('editBankModal').classList.remove('active');
                
                showNotification('Bank details updated. Please verify with ‚Ç¶1,050 to enable withdrawals.');
                
            } catch (error) {
                console.error('Error saving bank details:', error);
                showNotification('Error updating bank details');
            }
        }
        
        // Verify account number with bank (simulated)
        function verifyAccountNumber(bankName, accountNumber) {
            return new Promise((resolve) => {
                // Simulate API call delay
                setTimeout(() => {
                    // In a real app, this would call your backend API to verify with Paystack or other service
                    const names = ['Adeola Johnson', 'Chinedu Okoro', 'Fatima Bello', 'Emeka Nwachukwu', 'Amina Yusuf'];
                    const randomName = names[Math.floor(Math.random() * names.length)];
                    
                    resolve({
                        success: true,
                        accountName: randomName
                    });
                }, 1000);
            });
        }
        
        // Handle account number input
        document.getElementById('editAccountNumber').addEventListener('blur', async function() {
            const bankName = document.getElementById('editBankName').value;
            const accountNumber = this.value.trim();
            
            if (!bankName || !accountNumber || accountNumber.length !== 10) {
                return;
            }
            
            // Show loading
            document.getElementById('editAccountName').value = 'Verifying...';
            
            try {
                const verification = await verifyAccountNumber(bankName, accountNumber);
                
                if (verification.success) {
                    document.getElementById('editAccountName').value = verification.accountName;
                } else {
                    document.getElementById('editAccountName').value = 'Verification failed';
                }
            } catch (error) {
                console.error('Error verifying account:', error);
                document.getElementById('editAccountName').value = 'Error verifying';
            }
        });
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            // Set up theme toggle
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            document.getElementById('themeToggle').addEventListener('click', function() {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                
                // Update icon and text
                if (newTheme === 'dark') {
                    document.getElementById('themeIcon').textContent = '‚òÄÔ∏è';
                    document.getElementById('themeText').textContent = 'Light Mode';
                } else {
                    document.getElementById('themeIcon').textContent = 'üåô';
                    document.getElementById('themeText').textContent = 'Dark Mode';
                }
            });
            
            // Update icon and text based on current theme
            if (savedTheme === 'dark') {
                document.getElementById('themeIcon').textContent = '‚òÄÔ∏è';
                document.getElementById('themeText').textContent = 'Light Mode';
            }
            
            // Load user data
            await loadUserData();
            
            // Set up edit profile modal
            document.getElementById('editProfileBtn').addEventListener('click', function() {
                // Populate form with current data
                document.getElementById('editFullName').value = currentUser.fullName || '';
                document.getElementById('editEmail').value = currentUser.email || '';
                document.getElementById('editPhone').value = currentUser.phone || '';
                
                // Show modal
                document.getElementById('editProfileModal').classList.add('active');
            });
            
            document.getElementById('cancelEditProfile').addEventListener('click', function() {
                document.getElementById('editProfileModal').classList.remove('active');
            });
            
            document.getElementById('saveProfileBtn').addEventListener('click', saveProfileChanges);
            
            // Set up edit bank modal
            document.getElementById('editBankBtn').addEventListener('click', function() {
                // Populate form with current data if available
                if (currentUser.bankDetails) {
                    document.getElementById('editBankName').value = currentUser.bankDetails.bankName || '';
                    document.getElementById('editAccountNumber').value = currentUser.bankDetails.accountNumber || '';
                    document.getElementById('editAccountName').value = currentUser.bankDetails.accountName || '';
                } else {
                    document.getElementById('editBankName').value = '';
                    document.getElementById('editAccountNumber').value = '';
                    document.getElementById('editAccountName').value = '';
                }
                
                // Show modal
                document.getElementById('editBankModal').classList.add('active');
            });
            
            document.getElementById('cancelEditBank').addEventListener('click', function() {
                document.getElementById('editBankModal').classList.remove('active');
            });
            
            document.getElementById('saveBankBtn').addEventListener('click', saveBankDetails);
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', function() {
                if (confirm('Are you sure you want to logout?')) {
                    localStorage.removeItem('isLoggedIn');
                    localStorage.removeItem('userEmail');
                    localStorage.removeItem('userPhone');
                    window.location.href = 'index.html';
                }
            });
        });
    </script>
</body>
</html>
